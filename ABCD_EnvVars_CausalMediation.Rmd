---
title: "ABCD_EnvVars_CausalMediation"
author: "Wesley Meredith"
date: "2/20/2020"
output: html_document
---


Code for:                                                                                               
  1.  Importing DEAP ABCD RDS file available at ()                                                        
  2.  Gathering and cleaning relevant environment, sociodemographic, and neurocognitive BPPCAs           
          - for details on BPPCA, see Thompson et al., (2018). ()                           
  3.  Computing environment, sociodemographic, amd neurocognitive PCs                                    
  4.  Performing causal mediation analyses with:                                                                       
        - mediator: environment; outcome: 3 neurocognitive BPPCs 
        
        
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr); library(ggplot2); library(lme4); library(cvTools);  library(R.matlab); library(summarytools); library(readr);
library(psych); library(lme4); library(stargazer); library(gvlma);  library(extrafont); library(lattice); library(summarytools);
library(dplyr); library(ade4);  library(factoextra);  library(magrittr);  library(FactoMineR);  library(tidyr); library(fastDummies);
library(tidyverse); library(lavaan); library(semPlot); library(FactoMineR); library(factoextra); library(magrittr); library(FactoMineR);
library(mediation); library(data.table); library(corrplot); library(easystats); library(dplyr); library(Hmisc); library(foreach); library(doParallel);
library(tableone); library(gridExtra)

knitr::opts_knit$set(root.dir = "../../../")

```
## master data set just in case while working 
```{r}
test_data <- read_rds("~/Documents/data/release2rds/results/ABCD_release2.0.1_update_Rds/nda2.0.1.Rds")

acculturation_data <- test_data %>%
  filter(eventname == "baseline_year_1_arm_1") %>%
  dplyr::select(via_accult_ss_hc_p, via_accult_ss_amer_p, accult_phenx_q1, accult_phenx_q2, accult_phenx_q3_dropdwn,
               accult_phenx_q4, accult_phenx_q5, accult_phenx_q1_p, accult_phenx_q2_p, accult_phenx_q3_dropdwn_p,
              accult_phenx_q4_p, accult_phenx_q5_p)

acculturation_table <- CreateTableOne(data = acculturation_data)
summary(acculturation_table)

```


# 1. Import DEAP Rds file and set up working directories
```{r import_data}

abcd_data <- read_rds("~/Documents/data/release2rds/results/ABCD_release2.0.1_update_Rds/nda2.0.1.Rds") %>%
  filter(eventname == "baseline_year_1_arm_1") %>%
  dplyr::select(subjectid,
         abcd_site,
         age,
         demo_gender_id_p,
         demo_sex_p,
         female,
         race_ethnicity,
         demo_comb_income_p,#SES
         demo_prnt_ed_p,
         demo_prtnr_ed_p,
         meim_ss_exp_p,
         meim_ss_com_p,
         macvs_ss_fo_p,
         macvs_ss_fr_p,
         macvs_ss_fs_p,           
         macvs_ss_isr_p,           
         macvs_ss_r_p,
         fes_ss_fc_p_pr, #home env
         parental_monitoring_ss_mean,
         fes_ss_fc_pr,
         crpbi_acceptance_ss_studycaregiver,
         school_risk_phenx_ss_ses,#school env school_risk_phenx_ss_ses
         school_risk_phenx_ss_iiss, # school_risk_phenx_ss_iiss
         school_risk_phenx_ss_dfs, # school_risk_phenx_ss_dfs
         neighb_phenx_ss_mean_p, #neighborhood
         neighb_phenx,
         reshist_addr1_walkindex,
         reshist_addr1_no2,
         reshist_addr1_pm25,
         reshist_addr1_proxrd,
         reshist_addr1_d1a,
         reshist_addr1_p1vlnt, 
         reshist_addr1_drugtot, 
         reshist_addr1_drgsale, 
         reshist_addr1_drgposs, 
         reshist_addr1_dui,
         reshist_addr1_mjsale,
         reshist_addr1_adi_edu_l,
         reshist_addr1_adi_edu_h,
         reshist_addr1_adi_work_c,
         reshist_addr1_adi_income,
         reshist_addr1_adi_in_dis,
         reshist_addr1_adi_home_v,
         reshist_addr1_adi_rent,
         reshist_addr1_adi_mortg,
         reshist_addr1_adi_home_o,
         reshist_addr1_adi_unemp,
         reshist_addr1_adi_pov,
         reshist_addr1_adi_b138,
         reshist_addr1_adi_sp,
         reshist_addr1_adi_ncar,
         reshist_addr1_adi_ntel, 
         reshist_addr1_adi_nplumb, 
         reshist_addr1_adi_crowd,
         nihtbx_picvocab_uncorrected, nihtbx_flanker_uncorrected, nihtbx_list_uncorrected, nihtbx_cardsort_uncorrected, 
         nihtbx_pattern_uncorrected, nihtbx_picture_uncorrected, nihtbx_reading_uncorrected, pea_ravlt_sd_trial_i_tc,
         pea_ravlt_sd_trial_ii_tc, pea_ravlt_sd_trial_iii_tc, pea_ravlt_sd_trial_iv_tc, pea_ravlt_sd_trial_v_tc, lmt_scr_perc_correct,
         neurocog_pc1.bl,
         neurocog_pc2.bl,
         neurocog_pc3.bl)

ind_pea_ravlt = c(which(names(abcd_data)=="pea_ravlt_sd_trial_i_tc"),which(names(abcd_data)=="pea_ravlt_sd_trial_ii_tc"),
	which(names(abcd_data)=="pea_ravlt_sd_trial_iii_tc"),which(names(abcd_data)=="pea_ravlt_sd_trial_iv_tc"),
	which(names(abcd_data)=="pea_ravlt_sd_trial_v_tc"))

abcd_data$pea_ravlt_ld = apply(abcd_data[,ind_pea_ravlt],1,sum)
```

## dummy variables for sex and race/ethnicity; convert age to years; convert environment factor variables to continuous variables 
```{r dummy_coding}

abcd_data <- abcd_data %>% 
  dummy_cols(ignore_na = TRUE, select_columns = c("race_ethnicity")) %>%
  mutate(age = age/12,
         male = ifelse(female == "yes", 0, 1),
         neighb_phenx = as.numeric(factor(neighb_phenx, 
                               levels = c("Strongly Disagree", "Disagree", 
                                          "Neutral (neither agree nor disagree)",
                                          "Agree", "Strongly Agree"),
                               labels = c(1:5))))


```

## log transform neighborhood environment variables 
```{r log_transform}

abcd_data <- abcd_data %>%
  mutate(Res_density_log = log1p(reshist_addr1_d1a), #residential density
         UCR_ViolCrime_log = log1p(reshist_addr1_p1vlnt), # total adult violent crime
         UCR_DrugAbuse_log = log1p(reshist_addr1_drugtot), # drug abuse violations
         UCR_DrugSale_log = log1p(reshist_addr1_drgsale), #drug sale total
         UCR_DrugPoss_log = log1p(reshist_addr1_drgposs), # drug possession
         UCR_DUI_log = log1p(reshist_addr1_dui), # dui reports
         UCR_MJSale_log = log1p(reshist_addr1_mjsale), # marijuana sales
         ProxRoads_log = log(reshist_addr1_proxrd), # proximity to roads
         reshist_addr1_adi_ncar_log = log1p(reshist_addr1_adi_ncar),
         reshist_addr1_adi_ntel_log = log1p(reshist_addr1_adi_ntel),
         reshist_addr1_adi_nplumb_log = log1p(reshist_addr1_adi_nplumb),
         reshist_addr1_adi_crowd_log = log1p(reshist_addr1_adi_crowd))

```

## transform income and education variables into continuous integer values
```{r}

household.income = as.character(abcd_data$demo_comb_income_p)  
household.income[household.income == "Less than $5,000"] = 1 #  Less than $5,000
household.income[household.income == "$5,000 through $11,999"] = 2 # $5,000 through $11,999
household.income[household.income == "$12,000 through $15,999"] = 3 # $12,000 through $15,999
household.income[household.income == "$16,000 through $24,999"] = 4 # $16,000 through $24,999
household.income[household.income == "$25,000 through $34,999"] = 5 # $25,000 through $34,999
household.income[household.income == "$35,000 through $49,999"] = 6 # $35,000 through $49,999
household.income[household.income == "$50,000 through $74,999"] = 7 # $50,000 through $74,999
household.income[household.income == "$75,000 through $99,999"] = 8 # $75,000 through $99,999
household.income[household.income == "$100,000 through $199,999"] = 9 # $100,000 through $199,999
household.income[household.income == "$200,000 and greater"] = 10 # $200,000 and greater
household.income[household.income == "Don't know"] = NA
household.income[household.income == "Refuse to answer"] = NA
household.income[household.income %in% c(NA, "Don't know", "Refuse to answer")] = NA
abcd_data$household.income = factor( household.income, levels= 1:10, 
                                  labels = c("LT5K", "8.5K", "14K", "20.5K", "30K",
                                             "42.5K", "62.5K", "87.5K", "150K", "200KP") )

highest.education = rep("999", length(abcd_data$demo_prnt_ed_p))
highest.education[abcd_data$demo_prnt_ed_p == "Never attended/Kindergarten only"] = 0
highest.education[abcd_data$demo_prnt_ed_p == "1st grade"] = 1
highest.education[abcd_data$demo_prnt_ed_p == "2nd grade"] = 2
highest.education[abcd_data$demo_prnt_ed_p == "3rd grade"] = 3
highest.education[abcd_data$demo_prnt_ed_p == "4th grade"] = 4
highest.education[abcd_data$demo_prnt_ed_p == "5th grade"] = 5
highest.education[abcd_data$demo_prnt_ed_p == "6th grade"] = 6
highest.education[abcd_data$demo_prnt_ed_p == "7th grade"] = 7
highest.education[abcd_data$demo_prnt_ed_p == "8th grade"] = 8
highest.education[abcd_data$demo_prnt_ed_p == "9th grade"] = 9
highest.education[abcd_data$demo_prnt_ed_p == "10th grade"] = 10
highest.education[abcd_data$demo_prnt_ed_p == "11th grade"] = 11
highest.education[(abcd_data$demo_prnt_ed_p == "12th grade, no diploma")] = 12
highest.education[(abcd_data$demo_prnt_ed_p == "High school graduate")] = 13
highest.education[abcd_data$demo_prnt_ed_p == "GED or equivalent"] = 14
highest.education[abcd_data$demo_prnt_ed_p == "Some college, no degree"] = 15
highest.education[(abcd_data$demo_prnt_ed_p == "Associate degree: Occupational, Technical, or Vocational")] = 16
highest.education[(abcd_data$demo_prnt_ed_p == "Associate degree: Academic Program")] = 17
highest.education[abcd_data$demo_prnt_ed_p == "Bachelor's degree (ex. BA, AB, BS, BBS)"] = 18
highest.education[abcd_data$demo_prnt_ed_p == "Master's degree (ex. MA, MS, MEng, MEd, MBA)"] = 19
highest.education[abcd_data$demo_prnt_ed_p == "Professional School degree (ex. MD, DDS, DVN, JD)"] = 20
highest.education[abcd_data$demo_prnt_ed_p == "Doctoral degree (ex. PhD, EdD)"] = 21
highest.education[abcd_data$demo_prnt_ed_p == "Refused to answer"] = 999
highest.education[highest.education == 999] = NA

highest.education2 = rep("999", length(abcd_data$demo_prtnr_ed_p))
highest.education2[abcd_data$demo_prnt_ed_p == "Never attended/Kindergarten only"] = 0
highest.education2[abcd_data$demo_prnt_ed_p == "1st grade"] = 1
highest.education2[abcd_data$demo_prnt_ed_p == "2nd grade"] = 2
highest.education2[abcd_data$demo_prnt_ed_p == "3rd grade"] = 3
highest.education2[abcd_data$demo_prnt_ed_p == "4th grade"] = 4
highest.education2[abcd_data$demo_prnt_ed_p == "5th grade"] = 5
highest.education2[abcd_data$demo_prnt_ed_p == "6th grade"] = 6
highest.education2[abcd_data$demo_prnt_ed_p == "7th grade"] = 7
highest.education2[abcd_data$demo_prnt_ed_p == "8th grade"] = 8
highest.education2[abcd_data$demo_prnt_ed_p == "9th grade"] = 9
highest.education2[abcd_data$demo_prnt_ed_p == "10th grade"] = 10
highest.education2[abcd_data$demo_prnt_ed_p == "11th grade"] = 11
highest.education2[abcd_data$demo_prnt_ed_p == "12th grade, no diploma"] = 12 
highest.education2[abcd_data$demo_prnt_ed_p == "High school graduate"] = 13
highest.education2[abcd_data$demo_prnt_ed_p == "GED or equivalent"] = 14
highest.education2[abcd_data$demo_prnt_ed_p == "Some college, no degree"] = 15
highest.education2[abcd_data$demo_prnt_ed_p == "Associate degree: Occupational, Technical, or Vocational"] = 16 
highest.education2[abcd_data$demo_prnt_ed_p == "Associate degree: Academic Program"] = 17
highest.education2[abcd_data$demo_prnt_ed_p == "Bachelor's degree (ex. BA, AB, BS, BBS)"] = 18
highest.education2[abcd_data$demo_prnt_ed_p == "Master's degree (ex. MA, MS, MEng, MEd, MBA)"] = 19
highest.education2[abcd_data$demo_prnt_ed_p == "Professional School degree (ex. MD, DDS, DVN, JD)"] = 20
highest.education2[abcd_data$demo_prnt_ed_p == "Doctoral degree (ex. PhD, EdD)"] = 21
highest.education2[abcd_data$demo_prnt_ed_p == "Refused to answer"] = 999
highest.education2[highest.education2 == 999] = NA

abcd_data$highest.education = (pmax(as.numeric(highest.education), as.numeric(highest.education2),na.rm=T)) 


high.educ1 = highest.education
high.educ2 = highest.education2
high.educ1[which(high.educ1 == "999")] = NA
high.educ2[which(high.educ2 == "999")] = NA
high.educ1[which(high.educ1 == "777")] = NA
high.educ2[which(high.educ2 == "777")] = NA
high.educ = pmax(as.numeric(as.character(high.educ1)), as.numeric(as.character(high.educ2)), na.rm=T)
idx <- which(high.educ %in% 0:12, arr.ind = TRUE)
high.educ[idx] = 1 # "< HS Diploma"
idx <- which(high.educ %in% 13:14, arr.ind = TRUE)
high.educ[idx] = 2 # "HS Diploma/GED"
idx <- which(high.educ %in% 15:17, arr.ind = TRUE)
high.educ[idx] = 3 # "Some College"
idx <- which(high.educ == 18, arr.ind = TRUE)
high.educ[idx] = 4 # "Bachelor"
idx <- which(high.educ %in% 19:21, arr.ind = TRUE)
high.educ[idx] = 5 # "Post Graduate Degree"
high.educ[which(high.educ == "999")]=NA
high.educ[which(high.educ == "777")]=NA
abcd_data$high.educ = factor( high.educ, levels= 1:5, labels = c("LTHSDiploma","HSDiplomaGED","SomeCollege","Bachelor","PostGradDegree") )

household.income_num <- paste(abcd_data$household.income)
household.income_num[household.income_num == "LT5K"] = 5000 #  Less than $5,000
household.income_num[household.income_num == "8.5K"] = 8500 # $5,000 through $11,999
household.income_num[household.income_num == "14K"] = 14000 # $12,000 through $15,999
household.income_num[household.income_num == "20.5K"] = 20500 # $16,000 through $24,999
household.income_num[household.income_num == "30K"] = 30000 # $25,000 through $34,999
household.income_num[household.income_num == "42.5K"] = 42500 # $35,000 through $49,999
household.income_num[household.income_num == "62.5K"] = 62500 # $50,000 through $74,999
household.income_num[household.income_num == "87.5K"] = 87500 # $75,000 through $99,999
household.income_num[household.income_num == "150K"] = 150000 # $100,000 through $199,999
household.income_num[household.income_num == "200KP"] = 200000 # $200,000 and greater
abcd_data$household.income_num <- as.numeric(household.income_num)

```

## Gather and rename relevant variables
```{r}

abcd_data_final <- abcd_data %>%
  dplyr::select(subjectid, abcd_site, age, male, race_ethnicity_White, race_ethnicity_Black, race_ethnicity_Hispanic, race_ethnicity_Asian,
         race_ethnicity_Other, household.income_num, highest.education, meim_ss_exp_p, meim_ss_com_p, macvs_ss_fo_p, macvs_ss_fr_p,
         macvs_ss_fs_p, macvs_ss_isr_p, macvs_ss_r_p, fes_ss_fc_p_pr, parental_monitoring_ss_mean, fes_ss_fc_pr, crpbi_acceptance_ss_studycaregiver,
         school_risk_phenx_ss_ses, school_risk_phenx_ss_iiss, school_risk_phenx_ss_dfs, neighb_phenx_ss_mean_p, neighb_phenx, reshist_addr1_walkindex,
         reshist_addr1_no2, reshist_addr1_pm25, ProxRoads_log, Res_density_log, UCR_ViolCrime_log, UCR_DrugAbuse_log, UCR_DrugSale_log, UCR_DrugPoss_log,
         UCR_DUI_log, UCR_MJSale_log, reshist_addr1_adi_edu_l, reshist_addr1_adi_edu_h, reshist_addr1_adi_work_c, reshist_addr1_adi_income, 
         reshist_addr1_adi_in_dis, reshist_addr1_adi_home_v, reshist_addr1_adi_rent, reshist_addr1_adi_mortg, reshist_addr1_adi_home_o, reshist_addr1_adi_unemp,
         reshist_addr1_adi_pov, reshist_addr1_adi_b138, reshist_addr1_adi_sp, reshist_addr1_adi_ncar, reshist_addr1_adi_ntel, reshist_addr1_adi_nplumb,
         reshist_addr1_adi_crowd, nihtbx_picvocab_uncorrected, nihtbx_flanker_uncorrected, nihtbx_list_uncorrected, nihtbx_cardsort_uncorrected, 
         nihtbx_pattern_uncorrected, nihtbx_picture_uncorrected, nihtbx_reading_uncorrected, pea_ravlt_ld, lmt_scr_perc_correct, neurocog_pc1.bl, neurocog_pc2.bl, neurocog_pc3.bl)

colnames(abcd_data_final) <- c("subject_id",
                         "abcd_site",
                         "Age",
                         "Male",
                         "White",
                         "Black",
                         "Hispanic",
                         "Asian",
                         "Other",
                         "Income",
                         "Education",
                         "EthIdentExploration",
                         "EthIdentCommitment",
                         "FamObligation",
                         "FamReferent",
                         "FamSupport",
                         "IndepSelfReliance",
                         "Religion",
                         "FamConflict_P",
                         "ParentMonitoring",
                         "FamConflict_Y",
                         "ParentAcceptance",
                         "SchoolEnvironment",
                         "SchoolInvolvement",
                         "SchoolDisengagement",
                         "NeighSafety_P",
                         "NeighSafety_Y",
                         "Walkability",
                         "NO2Exposure",
                         "PM25Exposure",
                         "ProxRoads_log",
                         "ResDensity_log",
                         "UCR_ViolCrime_log", 
                         "UCR_DrugAbuse_log", 
                         "UCR_DrugSale_log", 
                         "UCR_DrugPoss_log", 
                         "UCR_DUI_log",
                         "UCR_MJSale_log",
                         "ADI_Edu_LTHS",
                         "ADI_Edu_HSDip",
                         "ADI_Occ_WhiteCollar",
                         "ADI_MedianFamInc",
                         "ADI_IncDisparityIdx",
                         "ADI_MedianHomeValue",
                         "ADI_MedianGrossRent",
                         "ADI_MedianMonthMortg",
                         "ADI_PercHOwner",
                         "ADI_PercUnemp",
                         "ADI_PercFamPoverty",
                         "ADI_PercPovBelow138",
                         "ADI_PercSingle",
                         "ADI_PercLogNCar",
                         "ADI_PercLogNTel",
                         "ADI_PercLogNPlumb",
                         "ADI_PercCrowding",
                         "NIHtb_PicVocab",
                         "NIHtb_Flanker",
                         "NIHtb_List",
                         "NIHtb_CardSort",
                         "NIHtb_Pattern",
                         "NIHtb_Picture",
                         "NIHtb_Reading",
                         "RAVLT",
                         "LMT",
                         "Neurocog_BPPC1_GenAbility",
                         "Neurocog_BPPC2_ExecFunc",
                         "Neurocog_BPPC3_LearnMem")

nmissing_abcd_data_final <- colSums(is.na(abcd_data_final))

abcd_data_final <- abcd_data_final[complete.cases(abcd_data_final),]

```

Create descriptive statistics table with missingness
```{r}

abcd_stats_total <- abcd_data %>%
  dplyr::select(abcd_site, age, male, race_ethnicity, household.income_num, highest.education, meim_ss_exp_p, meim_ss_com_p, macvs_ss_fo_p, macvs_ss_fr_p,
         macvs_ss_fs_p, macvs_ss_isr_p, macvs_ss_r_p, fes_ss_fc_p_pr, parental_monitoring_ss_mean, fes_ss_fc_pr, crpbi_acceptance_ss_studycaregiver,
         school_risk_phenx_ss_ses, school_risk_phenx_ss_iiss, school_risk_phenx_ss_dfs, neighb_phenx_ss_mean_p, neighb_phenx, reshist_addr1_walkindex,
         reshist_addr1_no2, reshist_addr1_pm25, ProxRoads_log, Res_density_log, UCR_ViolCrime_log, UCR_DrugAbuse_log, UCR_DrugSale_log, UCR_DrugPoss_log,
         UCR_DUI_log, UCR_MJSale_log, reshist_addr1_adi_edu_l, reshist_addr1_adi_edu_h, reshist_addr1_adi_work_c, reshist_addr1_adi_income, 
         reshist_addr1_adi_in_dis, reshist_addr1_adi_home_v, reshist_addr1_adi_rent, reshist_addr1_adi_mortg, reshist_addr1_adi_home_o, reshist_addr1_adi_unemp,
         reshist_addr1_adi_pov, reshist_addr1_adi_b138, reshist_addr1_adi_sp, reshist_addr1_adi_ncar, reshist_addr1_adi_ntel, reshist_addr1_adi_nplumb,
         reshist_addr1_adi_crowd, nihtbx_picvocab_uncorrected, nihtbx_flanker_uncorrected, nihtbx_list_uncorrected, nihtbx_cardsort_uncorrected, 
         nihtbx_pattern_uncorrected, nihtbx_picture_uncorrected, nihtbx_reading_uncorrected, pea_ravlt_ld, lmt_scr_perc_correct) %>%
  mutate(male = factor(male, levels = c(0,1), labels = c("female", "male")))

colnames(abcd_stats_total) <- c("abcd_site", "Age", "Sex", "RaceEthnicity", "Income", "Education", "EthIdentExploration", "EthIdentCommitment", "FamObligation", "FamReferent", "FamSupport", "IndepSelfReliance", "Religion", "FamConflict_P",  "ParentMonitoring", "FamConflict_Y",  "ParentAcceptance", "SchoolEnvironment", "SchoolInvolvement", "SchoolDisengagement", "NeighSafety_P", "NeighSafety_Y", "Walkability", "NO2Exposure", "PM25Exposure","ProxRoads_log", "ResDensity_log", "UCR_ViolCrime_log", "UCR_DrugAbuse_log", "UCR_DrugSale_log", "UCR_DrugPoss_log",  "UCR_DUI_log", "UCR_MJSale_log", "ADI_Edu_LTHS", "ADI_Edu_HSDip", "ADI_Occ_WhiteCollar", "ADI_MedianFamInc",  "ADI_IncDisparityIdx", "ADI_MedianHomeValue", "ADI_MedianGrossRent", "ADI_MedianMonthMortg",  "ADI_PercHOwner",
 "ADI_PercUnemp","ADI_PercFamPoverty", "ADI_PercPovBelow138","ADI_PercSingle","ADI_PercLogNCar", "ADI_PercLogNTel", "ADI_PercLogNPlumb", "ADI_PercCrowding", "NIHtb_PicVocab","NIHtb_Flanker","NIHtb_List", "NIHtb_CardSort", "NIHtb_Pattern", "NIHtb_Picture",  "NIHtb_Reading", "RAVLT","LMT")

abcd_stats_totaltab <- CreateTableOne(data = abcd_stats_total)
abcd_stats_summarytab <- summary(abcd_stats_totaltab)

abcd_stats_complete <- abcd_stats_total[complete.cases(abcd_stats_total),]

(abcd_stats_completetab <- CreateTableOne(data = abcd_stats_complete))


```


# 2. Gather necessary variables for 4 environment categories, sociodemographic, and neurocognitive BPPCA weights 
```{r}

CultureEnvVar_list <- data.table(c("EthIdentExploration",
                 "EthIdentCommitment",
                 "FamObligation",
                 "FamReferent",
                 "FamSupport",
                 "IndepSelfReliance",
                 "Religion"), "Culture")

HomeEnvVar_list <- data.table(c("FamConflict_P",
                 "ParentMonitoring",
                 "FamConflict_Y",
                 "ParentAcceptance"), "Home")

SchoolEnvVar_list <- data.table(c("SchoolEnvironment",
                   "SchoolInvolvement",
                   "SchoolDisengagement"), "School")

NeighborhoodEnvVar_list <- data.table(c("NeighSafety_P",
                         "NeighSafety_Y",
                         "Walkability",
                         "NO2Exposure",
                         "PM25Exposure",
                         "ProxRoads_log",
                         "ResDensity_log",
                         "UCR_ViolCrime_log", 
                         "UCR_DrugAbuse_log", 
                         "UCR_DrugSale_log", 
                         "UCR_DrugPoss_log", 
                         "UCR_DUI_log",
                         "UCR_MJSale_log",
                         "ADI_Edu_LTHS",
                         "ADI_Edu_HSDip",
                         "ADI_Occ_WhiteCollar",
                         "ADI_MedianFamInc",
                         "ADI_IncDisparityIdx",
                         "ADI_MedianHomeValue",
                         "ADI_MedianGrossRent",
                         "ADI_MedianMonthMortg",
                         "ADI_PercHOwner",
                         "ADI_PercUnemp",
                         "ADI_PercFamPoverty",
                         "ADI_PercPovBelow138",
                         "ADI_PercSingle",
                         "ADI_PercLogNCar",
                         "ADI_PercLogNTel",
                         "ADI_PercLogNPlumb",
                         "ADI_PercCrowding"), "Neighborhood")

NeurocogVar_list <- data.table(c("NIHtb_PicVocab",
                         "NIHtb_Flanker",
                         "NIHtb_List",
                         "NIHtb_CardSort",
                         "NIHtb_Pattern",
                         "NIHtb_Picture",
                         "NIHtb_Reading",
                         "RAVLT",
                         "LMT"), "Neurocog")

SociodemoVar_list <- data.table(c("Age",
                         "Male",
                         "White",
                         "Black",
                         "Hispanic",
                         "Asian",
                         "Other",
                         "Income",
                         "Education"), "Sociodemo")


```

## Create subject splits based on release (1.1 and 2.0.1) and site
```{r split_groups}
## Create 10,000 random splits between 22 study sites ##

set.seed(1992)

nrand <- 1000
n_sites <- length(unique(abcd_data_final$abcd_site))
n_site_split <- n_sites/2
site_list <- as.character(unique(abcd_data_final$abcd_site))
site_splits_rand <- data.frame(matrix(nrow = n_site_split, ncol = nrand))

for (i in 1:nrand){
  tmp_sitesplit <- sample(site_list, n_site_split, replace = FALSE, prob = NULL)
  site_splits_rand[,i] <- tmp_sitesplit
  
  rm(tmp_sitesplit)
}


## Split participants based on whether their data were first available with Release 1.1 or Release 2.0.1 ## 

# In order to determine who should belong in either release group, we must import subject IDs from a Release 1.1 text file. 
# Currently there does not appear to be a variable indicated which release participants' data were first avaialable with.

first_release_subjects <- read.delim("/Users/wesleymeredith/Documents/data/ABCD1.1/acspsw02.txt", na.strings=c(""," ","NA"), stringsAsFactors=FALSE) %>%
  slice(-1) %>% 
  dplyr::select(src_subject_id) 

first_release_data <- abcd_data_final %>%
  filter(subject_id %in% first_release_subjects[[1]]) %>%
  standardize()

first_release_bppca <- abcd_data_final %>%
  filter(subject_id %in% first_release_subjects[[1]]) %>%
  dplyr::select(Neurocog_BPPC1_GenAbility, Neurocog_BPPC2_ExecFunc, Neurocog_BPPC3_LearnMem)

second_release_data <- abcd_data_final %>%
  filter(subject_id %nin% first_release_subjects[[1]]) %>%
  standardize()

second_release_bppca <- abcd_data_final %>%
  filter(subject_id %nin% first_release_subjects[[1]]) %>%
  dplyr::select(Neurocog_BPPC1_GenAbility, Neurocog_BPPC2_ExecFunc, Neurocog_BPPC3_LearnMem)

```


# 3. Run PCA for environmental factors, sociodemographic factors, and neurocognitive scores- full and split samples
```{r message=FALSE, warning=FALSE}
## full sample PCAs
full_sample_data <- abcd_data_final %>% standardize()

full_culture_pca     <- PCA(full_sample_data[CultureEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
full_home_pca        <- PCA(full_sample_data[HomeEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
full_school_pca      <- PCA(full_sample_data[SchoolEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
full_neighborhood_pca <- PCA(full_sample_data[NeighborhoodEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
full_sociodemo_pca    <- PCA(full_sample_data[SociodemoVar_list$V1], scale.unit = TRUE, graph = TRUE)
full_neurocog_pca    <- PCA(full_sample_data[NeurocogVar_list$V1], scale.unit = TRUE, graph = TRUE)

full_sample_data <- full_sample_data %>%
        mutate(culture_PC1 = full_culture_pca$ind$coord[,1],
               home_PC1 = full_home_pca$ind$coord[,1],
               school_PC1 = full_school_pca$ind$coord[,1],
               neighborhood_PC1 = full_neighborhood_pca$ind$coord[,1],
               sociodemo_PC1 = full_sociodemo_pca$ind$coord[,1],
               neurocog_PC1 = full_neurocog_pca$ind$coord[,1],
               neurocog_PC2 = full_neurocog_pca$ind$coord[,2],
               neurocog_PC3 = full_neurocog_pca$ind$coord[,3],
               Neurocog_BPPC1_GenAbility = abcd_data_final$Neurocog_BPPC1_GenAbility,
               Neurocog_BPPC2_ExecFunc = abcd_data_final$Neurocog_BPPC2_ExecFunc,
               Neurocog_BPPC3_LearnMem = abcd_data_final$Neurocog_BPPC3_LearnMem)

write_csv(full_sample_data,
          "/Users/wesleymeredith/Documents/github_repos/shared_abcd_enviro/abcd_enviro/enviro_output/abcd_enviro_fullsample.csv")

## Release 1 and Release 2 group PCAs

## Release 1
rel1_culture_pca     <- PCA(first_release_data[CultureEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel1_home_pca        <- PCA(first_release_data[HomeEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel1_school_pca      <- PCA(first_release_data[SchoolEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel1_neighborhood_pca <- PCA(first_release_data[NeighborhoodEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel1_sociodemo_pca    <- PCA(first_release_data[SociodemoVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel1_neurocog_pca    <- PCA(first_release_data[NeurocogVar_list$V1], scale.unit = TRUE, graph = TRUE)

first_release_data <- first_release_data %>%
        mutate(culture_PC1 = rel1_culture_pca$ind$coord[,1],
               home_PC1 = rel1_home_pca$ind$coord[,1],
               school_PC1 = rel1_school_pca$ind$coord[,1],
               neighborhood_PC1 = rel1_neighborhood_pca$ind$coord[,1],
               sociodemo_PC1 = rel1_sociodemo_pca$ind$coord[,1],
               neurocog_PC1 = rel1_neurocog_pca$ind$coord[,1],
               neurocog_PC2 = rel1_neurocog_pca$ind$coord[,2],
               neurocog_PC3 = rel1_neurocog_pca$ind$coord[,3], 
               Neurocog_BPPC1_GenAbility = first_release_bppca$Neurocog_BPPC1_GenAbility,
               Neurocog_BPPC2_ExecFunc = first_release_bppca$Neurocog_BPPC2_ExecFunc,
               Neurocog_BPPC3_LearnMem = first_release_bppca$Neurocog_BPPC3_LearnMem)

write_csv(first_release_data,
          "/Users/wesleymeredith/Documents/github_repos/shared_abcd_enviro/abcd_enviro/enviro_output/abcd_enviro_firstrelease.csv")

## Release 2 
rel2_culture_pca     <- PCA(second_release_data[CultureEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel2_home_pca        <- PCA(second_release_data[HomeEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel2_school_pca      <- PCA(second_release_data[SchoolEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel2_neighborhood_pca <- PCA(second_release_data[NeighborhoodEnvVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel2_sociodemo_pca    <- PCA(second_release_data[SociodemoVar_list$V1], scale.unit = TRUE, graph = TRUE)
rel2_neurocog_pca         <- PCA(second_release_data[NeurocogVar_list$V1], scale.unit = TRUE, graph = TRUE)

second_release_data <- second_release_data %>%
        mutate(culture_PC1 = rel2_culture_pca$ind$coord[,1],
               home_PC1 = rel2_home_pca$ind$coord[,1],
               school_PC1 = rel2_school_pca$ind$coord[,1],
               neighborhood_PC1 = rel2_neighborhood_pca$ind$coord[,1],
               sociodemo_PC1 = rel2_sociodemo_pca$ind$coord[,1],
               neurocog_PC1 = rel2_neurocog_pca$ind$coord[,1],
               neurocog_PC2 = rel2_neurocog_pca$ind$coord[,2],
               neurocog_PC3 = rel2_neurocog_pca$ind$coord[,3],
               Neurocog_BPPC1_GenAbility = second_release_bppca$Neurocog_BPPC1_GenAbility,
               Neurocog_BPPC2_ExecFunc = second_release_bppca$Neurocog_BPPC2_ExecFunc,
               Neurocog_BPPC3_LearnMem = second_release_bppca$Neurocog_BPPC3_LearnMem)

write_csv(second_release_data,
          "/Users/wesleymeredith/Documents/github_repos/shared_abcd_enviro/abcd_enviro/enviro_output/abcd_enviro_secondrelease.csv")

## Random site groups 1 and 2 PCAs 
site1_culture_PC_list <- vector("list", nrand)
site1_home_PC_list <- vector("list", nrand)
site1_school_PC_list <- vector("list", nrand)
site1_neighborhood_PC_list <- vector("list", nrand)
site1_sociodemo_PC_list <- vector("list", nrand)
site1_neurocog_PC_list <- vector("list", nrand)

site2_culture_PC_list <- vector("list", nrand)
site2_home_PC_list <- vector("list", nrand)
site2_school_PC_list <- vector("list", nrand)
site2_neighborhood_PC_list <- vector("list", nrand)
site2_sociodemo_PC_list <- vector("list", nrand)
site2_neurocog_PC_list <- vector("list", nrand)

for (i in 1:nrand){
  
  site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,i]) %>%
    standardize()
  
  site2_data <- abcd_data_final %>%
    filter(abcd_site %nin% site_splits_rand[,i]) %>%
    standardize()
    
  site1_culture_PC_list[[i]]    <- PCA(site1_data[CultureEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site1_home_PC_list[[i]]    <- PCA(site1_data[HomeEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site1_school_PC_list[[i]]    <- PCA(site1_data[SchoolEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site1_neighborhood_PC_list[[i]]    <- PCA(site1_data[NeighborhoodEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site1_sociodemo_PC_list[[i]]    <- PCA(site1_data[SociodemoVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site1_neurocog_PC_list[[i]]    <- PCA(site1_data[NeurocogVar_list$V1], scale.unit = TRUE, graph = FALSE)
  
  site2_culture_PC_list[[i]]    <- PCA(site2_data[CultureEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site2_home_PC_list[[i]]    <- PCA(site2_data[HomeEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site2_school_PC_list[[i]]    <- PCA(site2_data[SchoolEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site2_neighborhood_PC_list[[i]]    <- PCA(site2_data[NeighborhoodEnvVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site2_sociodemo_PC_list[[i]]    <- PCA(site2_data[SociodemoVar_list$V1], scale.unit = TRUE, graph = FALSE)
  site2_neurocog_PC_list[[i]]    <- PCA(site2_data[NeurocogVar_list$V1], scale.unit = TRUE, graph = FALSE)
  
}

```

## Scree plots for Release 1 and Release 2 groups 
```{r}
#Release 1.1 
fviz_screeplot(rel1_culture_pca, addlabels =TRUE) +
  ggtitle("Release 1 Culture")
fviz_screeplot(rel1_home_pca, addlabels =TRUE) +
  ggtitle("Release 1 Home")
fviz_screeplot(rel1_school_pca, addlabels =TRUE) +
  ggtitle("Release 1 School")
fviz_screeplot(rel1_neighborhood_pca, addlabels =TRUE) +
  ggtitle("Release 1 Neighborhood")
fviz_screeplot(rel1_sociodemo_pca, addlabels =TRUE) +
  ggtitle("Release 1 Sociodemo")
fviz_screeplot(rel1_neurocog_pca, addlabels =TRUE) +
  ggtitle("Release 1 Neurocog")


#Release 2.0.1
fviz_screeplot(rel2_culture_pca, addlabels =TRUE) +
  ggtitle("Release 2 Culture")
fviz_screeplot(rel2_home_pca, addlabels =TRUE) +
  ggtitle("Release 2 Home")
fviz_screeplot(rel2_school_pca, addlabels =TRUE) +
  ggtitle("Release 2 School")
fviz_screeplot(rel2_neighborhood_pca, addlabels =TRUE) +
  ggtitle("Release 2 Neighborhood")
fviz_screeplot(rel2_sociodemo_pca, addlabels =TRUE) +
  ggtitle("Release 2 Sociodemo")
fviz_screeplot(rel2_neurocog_pca, addlabels =TRUE) +
  ggtitle("Release 2 Neurocog")
```



## Plot variable contributions for environment and sociodemographic categories

```{r}
# set colors for figs and plot theme
color_teal <- "#77AAAD"
color_grey <- "#6E7783"
color_red <-  "#D7191C"
color_orange <- "#d2a273"
color_blue <- "#2B83BA"
color_green <- "#729c6c"

pc_theme <- theme_minimal() + theme(legend.position="none", panel.grid.major = element_blank(), 
                                       panel.grid.minor = element_blank(), 
                                       axis.title.x = element_blank(), 
                                       axis.title.y = element_blank(),
                                       axis.text.x = element_text(size = 12),
                                       axis.text.y = element_text(size = 12))

pc_theme2 <- theme_minimal() + theme(legend.position="none", panel.grid.major = element_blank(), 
                                       panel.grid.minor = element_blank(), 
                                       axis.title.x = element_text(size = 14), 
                                       axis.title.y = element_blank(),
                                       axis.text.x = element_text(size = 12),
                                       axis.text.y = element_text(size = 12))

# Culture 
## rel 1.1 
rel1_culture_pccontrib <- data.table(Contribution = rel1_culture_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel1_culture_pca$var$contrib))

rel1_culture_pcdirect <- data.table(Coord = rel1_culture_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_culture_pca$var$coord))

rel1_negative_dir_culture <- which(rel1_culture_pcdirect$Coord < 0)
rel1_culture_pccontrib$Contribution[rel1_negative_dir_culture] <- -1 * rel1_culture_pccontrib$Contribution[rel1_negative_dir_culture]

(rel1_culture_pccontrib_plot <- rel1_culture_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_red) +
                coord_flip() +
                pc_theme )

ggsave("rel1_culture_pccontrib_plot.png")

## rel 2.0.1 
rel2_culture_pccontrib <- data.table(Contribution = rel2_culture_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel2_culture_pca$var$contrib))

rel2_culture_pcdirect <- data.table(Coord = rel2_culture_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_culture_pca$var$coord))

rel2_negative_dir_culture <- which(rel2_culture_pcdirect$Coord < 0)
rel2_culture_pccontrib$Contribution[rel2_negative_dir_culture] <- -1 * rel2_culture_pccontrib$Contribution[rel2_negative_dir_culture]

(rel2_culture_pccontrib_plot <- rel2_culture_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_red) +
                coord_flip() +
                pc_theme )

ggsave("rel2_culture_pccontrib_plot.png")

# Home 
## rel 1.1 
rel1_home_pccontrib <- data.table(Contribution = rel1_home_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel1_home_pca$var$contrib))

rel1_home_pcdirect <- data.table(Coord = rel1_home_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_home_pca$var$coord))

rel1_negative_dir_home <- which(rel1_home_pcdirect$Coord < 0)
rel1_home_pccontrib$Contribution[rel1_negative_dir_home] <- -1 * rel1_home_pccontrib$Contribution[rel1_negative_dir_home]

(rel1_home_pccontrib_plot <- rel1_home_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_orange) +
                coord_flip() +
                pc_theme )

ggsave("rel1_home_pccontrib_plot.png")

## rel 2.0.1
rel2_home_pccontrib <- data.table(Contribution = rel2_home_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel2_home_pca$var$contrib))

rel2_home_pcdirect <- data.table(Coord = rel2_home_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_home_pca$var$coord))

rel2_negative_dir_home <- which(rel2_home_pcdirect$Coord < 0)
rel2_home_pccontrib$Contribution[rel2_negative_dir_home] <- -1 * rel2_home_pccontrib$Contribution[rel2_negative_dir_home]

(rel2_home_pccontrib_plot <- rel2_home_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_orange) +
                coord_flip() +
                pc_theme )

ggsave("rel2_home_pccontrib_plot.png")

# school 
## rel 1.1 
rel1_school_pccontrib <- data.table(Contribution = rel1_school_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel1_school_pca$var$contrib))

rel1_school_pcdirect <- data.table(Coord = rel1_school_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_school_pca$var$coord))

rel1_negative_dir_school <- which(rel1_school_pcdirect$Coord < 0)
rel1_school_pccontrib$Contribution[rel1_negative_dir_school] <- -1 * rel1_school_pccontrib$Contribution[rel1_negative_dir_school]

(rel1_school_pccontrib_plot <- rel1_school_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_blue) +
                coord_flip() +
                pc_theme )

ggsave("rel1_school_pccontrib_plot.png")

## rel 2.0.1 
rel2_school_pccontrib <- data.table(Contribution = rel2_school_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel2_school_pca$var$contrib))

rel2_school_pcdirect <- data.table(Coord = rel2_school_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_school_pca$var$coord))

rel2_negative_dir_school <- which(rel2_school_pcdirect$Coord < 0)
rel2_school_pccontrib$Contribution[rel2_negative_dir_school] <- -1 * rel2_school_pccontrib$Contribution[rel2_negative_dir_school]

(rel2_school_pccontrib_plot <- rel2_school_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_blue) +
                coord_flip() +
                pc_theme )

ggsave("rel2_school_pccontrib_plot.png")

# neighborhood
## rel 1.1
rel1_neighborhood_pccontrib <- data.table(Contribution = rel1_neighborhood_pca$var$contrib[,1])%>%
        mutate(Variable = rownames(rel1_neighborhood_pca$var$contrib))

rel1_neighborhood_pcdirect <- data.table(Coord = rel1_neighborhood_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_neighborhood_pca$var$coord))

rel1_negative_dir_neighborhood <- which(rel1_neighborhood_pcdirect$Coord < 0)
rel1_neighborhood_pccontrib$Contribution[rel1_negative_dir_neighborhood] <- -1 * rel1_neighborhood_pccontrib$Contribution[rel1_negative_dir_neighborhood]

(rel1_neighborhood_pccontrib_plot <- rel1_neighborhood_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_green) +
                coord_flip() +
                pc_theme )

ggsave("rel1_neighborhood_pccontrib_plot.png")

## rel 2.0.1
rel2_neighborhood_pccontrib <- data.table(Contribution = rel2_neighborhood_pca$var$contrib[,1])%>%
        mutate(Variable = rownames(rel2_neighborhood_pca$var$contrib))

rel2_neighborhood_pcdirect <- data.table(Coord = rel2_neighborhood_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_neighborhood_pca$var$coord))

rel2_negative_dir_neighborhood <- which(rel2_neighborhood_pcdirect$Coord < 0)
rel2_neighborhood_pccontrib$Contribution[rel2_negative_dir_neighborhood] <- -1 * rel2_neighborhood_pccontrib$Contribution[rel2_negative_dir_neighborhood]

(rel2_neighborhood_pccontrib_plot <- rel2_neighborhood_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_green) +
                coord_flip() +
                pc_theme )

ggsave("rel2_neighborhood_pccontrib_plot.png")

# sociodemographics
## rel 1.1 
rel1_sociodemo_pccontrib <- data.table(Contribution = rel1_sociodemo_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel1_sociodemo_pca$var$contrib))

rel1_sociodemo_pcdirect <- data.table(Coord = rel1_sociodemo_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_sociodemo_pca$var$coord))

rel1_negative_dir_sociodemo <- which(rel1_sociodemo_pcdirect$Coord < 0)
rel1_sociodemo_pccontrib$Contribution[rel1_negative_dir_sociodemo] <- -1 * rel1_sociodemo_pccontrib$Contribution[rel1_negative_dir_sociodemo]

(rel1_sociodemo_pccontrib_plot <- rel1_sociodemo_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_grey) +
                coord_flip() +
                pc_theme2 )

ggsave("rel1_sociodemo_pccontrib_plot.png")

## rel 2.0.1
rel2_sociodemo_pccontrib <- data.table(Contribution = rel2_sociodemo_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel2_sociodemo_pca$var$contrib))

rel2_sociodemo_pcdirect <- data.table(Coord = rel2_sociodemo_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_sociodemo_pca$var$coord))

rel2_negative_dir_sociodemo <- which(rel2_sociodemo_pcdirect$Coord < 0)
rel2_sociodemo_pccontrib$Contribution[rel2_negative_dir_sociodemo] <- -1 * rel2_sociodemo_pccontrib$Contribution[rel2_negative_dir_sociodemo]

(rel2_sociodemo_pccontrib_plot <- rel2_sociodemo_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_grey) +
                coord_flip() +
                pc_theme2 )

ggsave("rel2_sociodemo_pccontrib_plot.png")

# cog scores - PC 1 
## rel 1.1 full_neurocog_pca
rel1_neurocog1_pccontrib <- data.table(Contribution = rel1_neurocog_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$contrib))

rel1_neurocog1_pcdirect <- data.table(Coord = rel1_neurocog_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$coord))

rel1_negative_dir_neurocog1 <- which(rel1_neurocog1_pcdirect$Coord < 0)
rel1_neurocog1_pccontrib$Contribution[rel1_negative_dir_neurocog1] <- -1 * rel1_neurocog1_pccontrib$Contribution[rel1_negative_dir_neurocog1]

(rel1_neurocog1_pccontrib_plot <- rel1_neurocog1_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel1_neurocog1_pccontrib_plot.png")

## rel 2.0.1 
rel2_neurocog1_pccontrib <- data.table(Contribution = rel2_neurocog_pca$var$contrib[,1]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$contrib))

rel2_neurocog1_pcdirect <- data.table(Coord = rel2_neurocog_pca$var$coord[,1]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$coord))

rel2_negative_dir_neurocog1 <- which(rel2_neurocog1_pcdirect$Coord < 0)
rel2_neurocog1_pccontrib$Contribution[rel2_negative_dir_neurocog1] <- -1 * rel2_neurocog1_pccontrib$Contribution[rel2_negative_dir_neurocog1]

(rel2_neurocog1_pccontrib_plot <- rel2_neurocog1_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel2_neurocog1_pccontrib_plot.png")

# cog scores - PC 2 
## rel 1.1 full_neurocog_pca
rel1_neurocog2_pccontrib <- data.table(Contribution = rel1_neurocog_pca$var$contrib[,2]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$contrib))

rel1_neurocog2_pcdirect <- data.table(Coord = rel1_neurocog_pca$var$coord[,2]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$coord))

rel1_negative_dir_neurocog2 <- which(rel1_neurocog2_pcdirect$Coord < 0)
rel1_neurocog2_pccontrib$Contribution[rel1_negative_dir_neurocog2] <- -1 * rel1_neurocog2_pccontrib$Contribution[rel1_negative_dir_neurocog2]

(rel1_neurocog2_pccontrib_plot <- rel1_neurocog2_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel1_neurocog2_pccontrib_plot.png")

## rel 2.0.1 
rel2_neurocog2_pccontrib <- data.table(Contribution = rel2_neurocog_pca$var$contrib[,2]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$contrib))

rel2_neurocog2_pcdirect <- data.table(Coord = rel2_neurocog_pca$var$coord[,2]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$coord))

rel2_negative_dir_neurocog2 <- which(rel2_neurocog2_pcdirect$Coord < 0)
rel2_neurocog2_pccontrib$Contribution[rel2_negative_dir_neurocog2] <- -1 * rel2_neurocog2_pccontrib$Contribution[rel2_negative_dir_neurocog2]

(rel2_neurocog2_pccontrib_plot <- rel2_neurocog2_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel2_neurocog2_pccontrib_plot.png")

# cog scores - PC 3 
## rel 1.1 full_neurocog_pca
rel1_neurocog3_pccontrib <- data.table(Contribution = rel1_neurocog_pca$var$contrib[,3]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$contrib))

rel1_neurocog3_pcdirect <- data.table(Coord = rel1_neurocog_pca$var$coord[,3]) %>%
        mutate(Variable = rownames(rel1_neurocog_pca$var$coord))

rel1_negative_dir_neurocog3 <- which(rel1_neurocog3_pcdirect$Coord < 0)
rel1_neurocog3_pccontrib$Contribution[rel1_negative_dir_neurocog3] <- -1 * rel1_neurocog3_pccontrib$Contribution[rel1_negative_dir_neurocog3]

(rel1_neurocog3_pccontrib_plot <- rel1_neurocog3_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel1_neurocog3_pccontrib_plot.png")

## rel 2.0.1 
rel2_neurocog3_pccontrib <- data.table(Contribution = rel2_neurocog_pca$var$contrib[,3]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$contrib))

rel2_neurocog3_pcdirect <- data.table(Coord = rel2_neurocog_pca$var$coord[,3]) %>%
        mutate(Variable = rownames(rel2_neurocog_pca$var$coord))

rel2_negative_dir_neurocog3 <- which(rel2_neurocog3_pcdirect$Coord < 0)
rel2_neurocog3_pccontrib$Contribution[rel2_negative_dir_neurocog3] <- -1 * rel2_neurocog3_pccontrib$Contribution[rel2_negative_dir_neurocog3]

(rel2_neurocog3_pccontrib_plot <- rel2_neurocog3_pccontrib %>%
                ggplot(aes(x = reorder(Variable, Contribution), y = Contribution)) +
                geom_bar(stat = "identity", position = "dodge", fill = color_teal) +
                coord_flip() +
                pc_theme )

ggsave("rel2_neurocog3_pccontrib_plot.png")


```

## Combine plots for Release 1 and 2 PCs
```{r}

(relplot_pcfig <- grid.arrange(rel1_home_pccontrib_plot,
                                     rel2_home_pccontrib_plot,
                                     rel1_school_pccontrib_plot,
                                     rel2_school_pccontrib_plot,
                                     rel1_neighborhood_pccontrib_plot,
                               rel2_neighborhood_pccontrib_plot,
                                     rel1_culture_pccontrib_plot,
                               rel2_culture_pccontrib_plot, 
                               rel1_sociodemo_pccontrib_plot,
                               rel2_sociodemo_pccontrib_plot,
                                     heights = c(1, 1, 3, 1, 1),
                                     nrow = 5))
ggsave('relplot_pcfig.png', relplot_pcfig, height = 17, width = 14)

```


## Compare BPPCA and PCA results for neurocognitive scores for complete case participants

```{r}

# Cor test for Neurocog PC1 and Neurocog BPPC1 
## all subjects 
(neurocog1_corr <- cor.test(full_sample_data$neurocog_PC1, full_sample_data$Neurocog_BPPC1_GenAbility, method = "spearman"))

## Release 1.1 
(neurocog1_rel1_corr <- cor.test(first_release_data$neurocog_PC1, first_release_data$Neurocog_BPPC1_GenAbility, method = "spearman"))

## Release 2.0.1
(neurocog1_rel2_corr <- cor.test(second_release_data$neurocog_PC1, second_release_data$Neurocog_BPPC1_GenAbility, method = "spearman"))

# Cor test for Neurocog PC2 and Neurocog BPPC2 
## all subjects 
(neurocog2_corr <- cor.test(full_sample_data$neurocog_PC2, full_sample_data$Neurocog_BPPC2_ExecFunc, method = "spearman"))

## Release 1.1 
(neurocog2_rel1_corr <- cor.test(first_release_data$neurocog_PC2, first_release_data$Neurocog_BPPC2_ExecFunc , method = "spearman"))

## Release 2.0.1
(neurocog2_rel2_corr <- cor.test(second_release_data$neurocog_PC2, second_release_data$Neurocog_BPPC2_ExecFunc , method = "spearman"))

# Cor test for Neurocog PC3 and Neurocog BPPC3
## all subjects 
(neurocog3_corr <- cor.test(full_sample_data$neurocog_PC3, full_sample_data$Neurocog_BPPC3_LearnMem, method = "spearman"))

## Release 1.1 
(neurocog3_rel1_corr <- cor.test(first_release_data$neurocog_PC3, first_release_data$Neurocog_BPPC3_LearnMem , method = "spearman"))

## Release 2.0.1
(neurocog3_rel2_corr <- cor.test(second_release_data$neurocog_PC3, second_release_data$Neurocog_BPPC3_LearnMem , method = "spearman"))

```


## Compare variable loadings across site splits

```{r}
# culture 
(rel_culture_corr <- cor.test(rel1_culture_pccontrib$Contribution, rel2_culture_pccontrib$Contribution, method = "pearson"))

# home 
(rel_home_corr <- cor.test(rel1_home_pccontrib$Contribution, rel2_home_pccontrib$Contribution, method = "pearson"))

#school
(rel_school_corr <- cor.test(rel1_school_pccontrib$Contribution, rel2_school_pccontrib$Contribution, method = "pearson"))

#neighborhood
(rel_neighborhood_corr <- cor.test(rel1_neighborhood_pccontrib$Contribution, rel2_neighborhood_pccontrib$Contribution, method = "pearson"))

```


## Plot correlation matrix with enviro/sociodemo vars and cog BPPCAs

```{r warning=FALSE, message=FALSE}

## Release 1.1 and Release 2.0.1  corr plot 

rel1var_corr <- cor(first_release_data[, c(3:55, 65:67)])
rel2var_corr <- cor(second_release_data[, c(3:55, 65:67)])

(rel1var_corrplot <- corrplot(rel1var_corr, method = 'color', type = "full", diag = FALSE, cl.pos = "b", cl.cex = .5, pch.col = "black", tl.cex = .15, tl.srt = 20, tl.col = "black"))

(rel2var_corrplot <- corrplot(rel2var_corr, method = 'color', type = "full", diag = FALSE, cl.pos = "b", cl.cex = .5, pch.col = "black", tl.cex = .15, tl.srt = 20, tl.col = "black"))

relcomb_corr <- matrix(NA, nrow = 56, ncol = 56)
relcomb_corr[lower.tri(relcomb_corr)] <- rel1var_corr[lower.tri(rel1var_corr)]
relcomb_corr[upper.tri(relcomb_corr)] <- rel2var_corr[upper.tri(rel2var_corr)]
diag(relcomb_corr) <-  0

rel1var_corr_pvals <- cor.mtest(first_release_data[, c(3:55, 65:67)], method = "spearman")
rel2var_corr_pvals <- cor.mtest(second_release_data[, c(3:55, 65:67)], method = "spearman")

relcom_corr_pvals <- matrix(NA, nrow = 56, ncol = 56)
relcom_corr_pvals[lower.tri(relcom_corr_pvals)] <- rel1var_corr_pvals$p[lower.tri(rel1var_corr_pvals$p)]
relcom_corr_pvals[upper.tri(relcom_corr_pvals)] <- rel2var_corr_pvals$p[upper.tri(rel2var_corr_pvals$p)]
diag(relcom_corr_pvals) <- 0

png("relcom_corrplot.png", res = 600, width = 14000, height = 14000)
variable_corrplot <- corrplot(relcomb_corr, method = 'color', type = "full", diag = FALSE, cl.pos = "b", cl.cex = 2.5, tl.cex = 2.15, tl.srt = 20, tl.col = "black")
dev.off()

## full sample corr plot 
fullvar_corr <- cor(full_sample_data[, c(3:55, 65:67)])
fullvar_corr_pvals <- cor.mtest(full_sample_data[,c(3:55, 65:67)], method = "spearman")

png("fullvar_corrplot.png", res = 600, width = 14000, height = 14000)
variable_corrplot <- corrplot(fullvar_corr, method = 'color', type = "full", diag = FALSE, p.mat =fullvar_corr_pvals$p, 
                              insig = "label_sig", cl.pos = "b", cl.cex = 2.5, pch.col = "black", pch.cex = 2.25, tl.cex = 2.15, tl.srt = 20, tl.col = "black")
dev.off()

```


# 4. Perform Causal Mediation Analysis 

## Full Sample Mediation
```{r}

# school neurocog dim 1 
full1_school_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = full_sample_data)
summary(full1_school_totaleffect)

full1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full1_school_demenviro_patha)

full1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = full_sample_data)
summary(full1_school_envirocog_pathb)

full1_school_mediation <- mediate(full1_school_demenviro_patha, full1_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full1_school_mediation)

# school neurocog dim 2 
full2_school_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = full_sample_data)
summary(full2_school_totaleffect)

full2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full2_school_demenviro_patha)

full2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = full_sample_data)
summary(full2_school_envirocog_pathb)

full2_school_mediation <- mediate(full2_school_demenviro_patha, full2_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full2_school_mediation)

# school neurocog dim 3 
full3_school_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = full_sample_data)
summary(full3_school_totaleffect)

full3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full3_school_demenviro_patha)

full3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = full_sample_data)
summary(full3_school_envirocog_pathb)

full3_school_mediation <- mediate(full3_school_demenviro_patha, full3_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full3_school_mediation)

# home neurocog dim 1 
full1_home_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = full_sample_data)
summary(full1_home_totaleffect)

full1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full1_home_demenviro_patha)

full1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = full_sample_data)
summary(full1_home_envirocog_pathb)

full1_home_mediation <- mediate(full1_home_demenviro_patha, full1_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full1_home_mediation)

# home neurocog dim 2 
full2_home_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = full_sample_data)
summary(full2_home_totaleffect)

full2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full2_home_demenviro_patha)

full2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = full_sample_data)
summary(full2_home_envirocog_pathb)

full2_home_mediation <- mediate(full2_home_demenviro_patha, full2_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full2_home_mediation)

# home neurocog dim 3 
full3_home_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = full_sample_data)
summary(full3_home_totaleffect)

full3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full3_home_demenviro_patha)

full3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = full_sample_data)
summary(full3_home_envirocog_pathb)

full3_home_mediation <- mediate(full3_home_demenviro_patha, full3_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full3_home_mediation)

# culture neurocog dim 1 
full1_culture_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = full_sample_data)
summary(full1_culture_totaleffect)

full1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full1_culture_demenviro_patha)

full1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = full_sample_data)
summary(full1_culture_envirocog_pathb)

full1_culture_mediation <- mediate(full1_culture_demenviro_patha, full1_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full1_culture_mediation)

# culture neurocog dim 2
full2_culture_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = full_sample_data)
summary(full2_culture_totaleffect)

full2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full2_culture_demenviro_patha)

full2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = full_sample_data)
summary(full2_culture_envirocog_pathb)

full2_culture_mediation <- mediate(full2_culture_demenviro_patha, full2_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full2_culture_mediation)

# culture neurocog dim 3
full3_culture_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = full_sample_data)
summary(full3_culture_totaleffect)

full3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full3_culture_demenviro_patha)

full3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = full_sample_data)
summary(full3_culture_envirocog_pathb)

full3_culture_mediation <- mediate(full3_culture_demenviro_patha, full3_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full3_culture_mediation)

# neighborhood neurocog dim 1 
full1_neighborhood_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = full_sample_data)
summary(full1_neighborhood_totaleffect)

full1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full1_neighborhood_demenviro_patha)

full1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = full_sample_data)
summary(full1_neighborhood_envirocog_pathb)

full1_neighborhood_mediation <- mediate(full1_neighborhood_demenviro_patha, full1_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full1_neighborhood_mediation)

# neighborhood neurocog dim 2
full2_neighborhood_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = full_sample_data)
summary(full2_neighborhood_totaleffect)

full2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full2_neighborhood_demenviro_patha)

full2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = full_sample_data)
summary(full2_neighborhood_envirocog_pathb)

full2_neighborhood_mediation <- mediate(full2_neighborhood_demenviro_patha, full2_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full2_neighborhood_mediation)

# neighborhood neurocog dim 3
full3_neighborhood_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = full_sample_data)
summary(full3_neighborhood_totaleffect)

full3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = full_sample_data)
summary(full3_neighborhood_demenviro_patha)

full3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = full_sample_data)
summary(full3_neighborhood_envirocog_pathb)

full3_neighborhood_mediation <- mediate(full3_neighborhood_demenviro_patha, full3_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(full3_neighborhood_mediation)
```


## Release 1.1 Mediation 

### Release 1.1 Home Environment and BPPCA 1 
```{r}
firstrel1_home_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_home_totaleffect)

firstrel1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_home_demenviro_patha)

firstrel1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = first_release_data)
summary(firstrel1_home_envirocog_pathb)

firstrel1_home_mediation <- mediate(firstrel1_home_demenviro_patha, firstrel1_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel1_home_mediation)

```


### Release 1.1 Home Environment and BPPCA 2
```{r}
firstrel2_home_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_home_totaleffect)

firstrel2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_home_demenviro_patha)

firstrel2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = first_release_data)
summary(firstrel2_home_envirocog_pathb)

firstrel2_home_mediation <- mediate(firstrel2_home_demenviro_patha, firstrel2_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel2_home_mediation)

```


### Release 1.1 Home Environment and BPPCA 3 
```{r}
firstrel3_home_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_home_totaleffect)

firstrell3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrell3_home_demenviro_patha)

firstrel3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = first_release_data)
summary(firstrel3_home_envirocog_pathb)

firstrel3_home_mediation <- mediate(firstrell3_home_demenviro_patha, firstrel3_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel3_home_mediation)

```


### Release 1.1 School Environment and BPPCA 1
```{r}
firstrel1_school_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_school_totaleffect)

firstrel1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_school_demenviro_patha)

firstrel1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = first_release_data)
summary(firstrel1_school_envirocog_pathb)

firstrel1_school_mediation <- mediate(firstrel1_school_demenviro_patha, firstrel1_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel1_school_mediation)

```


### Release 1.1 School Environment and BPPCA 2
```{r}
firstrel2_school_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_school_totaleffect)

firstrel2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_school_demenviro_patha)

firstrel2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = first_release_data)
summary(firstrel2_school_envirocog_pathb)

firstrel2_school_mediation <- mediate(firstrel2_school_demenviro_patha, firstrel2_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel2_school_mediation)
```


### Release 1.1 School Environment and BPPCA 3
```{r}
firstrel3_school_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_school_totaleffect)

firstrel3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_school_demenviro_patha)

firstrel3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = first_release_data)
summary(firstrel3_school_envirocog_pathb)

firstrel3_school_mediation <- mediate(firstrel3_school_demenviro_patha, firstrel3_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel3_school_mediation)
```


### Release 1.1 Neighborhood Environment and BPPCA 1
```{r}
firstrel1_neighborhood_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_neighborhood_totaleffect)

firstrel1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_neighborhood_demenviro_patha)

firstrel1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = first_release_data)
summary(firstrel1_neighborhood_envirocog_pathb)

firstrel1_neighborhood_mediation <- mediate(firstrel1_neighborhood_demenviro_patha, firstrel1_neighborhood_envirocog_pathb, 
                                            treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel1_neighborhood_mediation)

```


### Release 1.1 Neighborhood Environment and BPPCA 2
```{r}
firstrel2_neighborhood_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_neighborhood_totaleffect)

firstrel2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_neighborhood_demenviro_patha)

firstrel2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = first_release_data)
summary(firstrel2_neighborhood_envirocog_pathb)

firstrel2_neighborhood_mediation <- mediate(firstrel2_neighborhood_demenviro_patha, firstrel2_neighborhood_envirocog_pathb, 
                                            treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel2_neighborhood_mediation)

```


### Release 1.1 Neighborhood Environment and BPPCA 3
```{r}
firstrel3_neighborhood_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_neighborhood_totaleffect)

firstrel3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_neighborhood_demenviro_patha)

firstrel3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = first_release_data)
summary(firstrel3_neighborhood_envirocog_pathb)

firstrel3_neighborhood_mediation <- mediate(firstrel3_neighborhood_demenviro_patha, firstrel3_neighborhood_envirocog_pathb, 
                                        treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel3_neighborhood_mediation)

```


### Release 1.1 Culture Environment and BPPCA 1
```{r}
firstrel1_culture_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_culture_totaleffect)

firstrel1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel1_culture_demenviro_patha)

firstrel1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = first_release_data)
summary(firstrel1_culture_envirocog_pathb)

firstrel1_culture_mediation <- mediate(firstrel1_culture_demenviro_patha, firstrel1_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel1_culture_mediation)

```


### Release 1.1 Culture Environment and BPPCA 2
```{r}
firstrel2_culture_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_culture_totaleffect)

firstrel2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel2_culture_demenviro_patha)

firstrel2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = first_release_data)
summary(firstrel2_culture_envirocog_pathb)

firstrel2_culture_mediation <- mediate(firstrel2_culture_demenviro_patha, firstrel2_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel2_culture_mediation)

```


### Release 1.1 Culture Environment and BPPCA 3
```{r}
firstrel3_culture_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_culture_totaleffect)

firstrel3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = first_release_data)
summary(firstrel3_culture_demenviro_patha)

firstrel3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = first_release_data)
summary(firstrel3_culture_envirocog_pathb)

firstrel3_culture_mediation <- mediate(firstrel3_culture_demenviro_patha, firstrel3_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(firstrel3_culture_mediation)

```

## Release 2.0.1 Mediation 

### Release 2.0.1 Home Environment and BPPCA 1 
```{r}
secondrel1_home_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_home_totaleffect)

secondrel1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_home_demenviro_patha)

secondrel1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = second_release_data)
summary(secondrel1_home_envirocog_pathb)

secondrel1_home_mediation <- mediate(secondrel1_home_demenviro_patha, secondrel1_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel1_home_mediation)
```


### Release 2.0.1 Home Environment and BPPCA 2
```{r}
secondrel2_home_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_home_totaleffect)

secondrel2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_home_demenviro_patha)

secondrel2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = second_release_data)
summary(secondrel2_home_envirocog_pathb)

secondrel2_home_mediation <- mediate(secondrel2_home_demenviro_patha, secondrel2_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel2_home_mediation)
```


### Release 2.0.1 Home Environment and BPPCA 3 
```{r}
secondrel3_home_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_home_totaleffect)

secondrel3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_home_demenviro_patha)

secondrel3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = second_release_data)
summary(secondrel3_home_envirocog_pathb)

secondrel3_home_mediation <- mediate(secondrel3_home_demenviro_patha, secondrel3_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel3_home_mediation)
```


### Release 2.0.1 School Environment and BPPCA 1
```{r}
secondrel1_school_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_school_totaleffect)

secondrel1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_school_demenviro_patha)

secondrel1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = second_release_data)
summary(secondrel1_school_envirocog_pathb)

secondrel1_school_mediation <- mediate(secondrel1_school_demenviro_patha, secondrel1_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel1_school_mediation)

```


### Release 2.0.1 School Environment and BPPCA 2
```{r}
secondrel2_school_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_school_totaleffect)

secondrel2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_school_demenviro_patha)

secondrel2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = second_release_data)
summary(secondrel2_school_envirocog_pathb)

secondrel2_school_mediation <- mediate(secondrel2_school_demenviro_patha, secondrel2_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel2_school_mediation)
```


### Release 2.0.1 School Environment and BPPCA 3
```{r}
secondrel3_school_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_school_totaleffect)

secondrel3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_school_demenviro_patha)

secondrel3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = second_release_data)
summary(secondrel3_school_envirocog_pathb)

secondrel3_school_mediation <- mediate(secondrel3_school_demenviro_patha, secondrel3_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel3_school_mediation)

```


### Release 2.0.1 Neighborhood Environment and BPPCA 1
```{r}
secondrel1_neighborhood_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_neighborhood_totaleffect)

secondrel1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_neighborhood_demenviro_patha)

secondrel1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = second_release_data)
summary(secondrel1_neighborhood_envirocog_pathb)

secondrel1_neighborhood_mediation <- mediate(secondrel1_neighborhood_demenviro_patha, secondrel1_neighborhood_envirocog_pathb, 
                                            treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel1_neighborhood_mediation)
```


### Release 2.0.1 Neighborhood Environment and BPPCA 2
```{r}
secondrel2_neighborhood_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_neighborhood_totaleffect)

secondrel2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_neighborhood_demenviro_patha)

secondrel2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = second_release_data)
summary(secondrel2_neighborhood_envirocog_pathb)

secondrel2_neighborhood_mediation <- mediate(secondrel2_neighborhood_demenviro_patha, secondrel2_neighborhood_envirocog_pathb, 
                                            treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel2_neighborhood_mediation)

```


### Release 2.0.1 Neighborhood Environment and BPPCA 3
```{r}
secondrel3_neighborhood_totaleffect <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_neighborhood_totaleffect)

secondrel3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel3_neighborhood_demenviro_patha)

secondrel3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = second_release_data)
summary(secondrel3_neighborhood_envirocog_pathb)

secondrel3_neighborhood_mediation <- mediate(secondrel3_neighborhood_demenviro_patha, secondrel3_neighborhood_envirocog_pathb, 
                                        treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel3_neighborhood_mediation)

```


### Release 2.0.1 Culture Environment and BPPCA 1
```{r}
secondrel1_culture_totaleffect <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_culture_totaleffect)

secondrel1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel1_culture_demenviro_patha)

secondrel1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = second_release_data)
summary(secondrel1_culture_envirocog_pathb)

secondrel1_culture_mediation <- mediate(secondrel1_culture_demenviro_patha, secondrel1_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel1_culture_mediation)
```


### Release 2.0.1 Culture Environment and BPPCA 2
```{r}
secondrel2_culture_totaleffect <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_culture_totaleffect)

secondrel2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = second_release_data)
summary(secondrel2_culture_demenviro_patha)

secondrel2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = second_release_data)
summary(secondrel2_culture_envirocog_pathb)

secondrel2_culture_mediation <- mediate(secondrel2_culture_demenviro_patha, secondrel2_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel2_culture_mediation)
```


### Release 2.0.1 Culture Environment and BPPCA 3
```{r}
secondrel3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = second_release_data)

secondrel3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = second_release_data)

secondrel3_culture_mediation <- mediate(secondrel3_culture_demenviro_patha, secondrel3_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')

summary(secondrel3_culture_mediation)
```

## Adjust p-values for mediation effects using bonferoni correction

```{r}

rel1_padjust <- c(firstrel1_culture_mediation, firstrel2_culture_mediation, firstrel3_culture_mediation,
                  firstrel1_home_mediation, firstrel2_home_mediation, firstrel3_home_mediation,
                  firstrel1_school_mediation, firstrel2_school_mediation, firstrel3_school_mediation,
                  firstrel1_neighborhood_mediation, firstrel2_neighborhood_mediation, firstrel3_neighborhood_mediation) %>%
  p.adjust(method = "bonferoni", n = 12)

rel2_padjust <- c(secondrel1_culture_mediation, secondrel2_culture_mediation, secondrel3_culture_mediation,
                  secondrel1_home_mediation, secondrel2_home_mediation, secondrel3_home_mediation,
                  secondrel1_school_mediation, secondrel2_school_mediation, secondrel3_school_mediation,
                  secondrel1_neighborhood_mediation, secondrel2_neighborhood_mediation, secondrel3_neighborhood_mediation) %>%
  p.adjust(method = "bonferoni", n = 12)

```


# Reverse models 

## Release 1 Reverse Models 
```{r}
## Rel 1 PC 1 Home
firstrel1_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = first_release_data)
firstrel1_home_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ home_PC1 + sociodemo_PC1, data = first_release_data)

firstrel1_home_mediationrev <- mediate(firstrel1_home_patharev, firstrel1_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel1_home_mediationrev)

## Rel 1 PC 2 Home 
firstrel2_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = first_release_data)
firstrel2_home_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ home_PC1 + sociodemo_PC1, data = first_release_data)

firstrel2_home_mediationrev <- mediate(firstrel2_home_patharev, firstrel2_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel2_home_mediationrev)

## Rel 1 PC 3 Home 
firstrel3_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = first_release_data)
firstrel3_home_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ home_PC1 + sociodemo_PC1, data = first_release_data)

firstrel3_home_mediationrev <- mediate(firstrel3_home_patharev, firstrel3_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel3_home_mediationrev)

## Rel 1 PC 1 School 
firstrel1_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = first_release_data)
firstrel1_school_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ school_PC1 + sociodemo_PC1, data = first_release_data)

firstrel1_school_mediationrev <- mediate(firstrel1_school_patharev, firstrel1_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel1_school_mediationrev)

## Rel 1 PC 2 School
firstrel2_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = first_release_data)
firstrel2_school_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ school_PC1 + sociodemo_PC1, data = first_release_data)

firstrel2_school_mediationrev <- mediate(firstrel2_school_patharev, firstrel2_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel2_school_mediationrev)

## Rel 1 PC 3 School
firstrel3_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = first_release_data)
firstrel3_school_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ school_PC1 + sociodemo_PC1, data = first_release_data)

firstrel3_school_mediationrev <- mediate(firstrel3_school_patharev, firstrel3_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel3_school_mediationrev)

## Rel 1 PC 1 Neighborhood
firstrel1_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = first_release_data)
firstrel1_neighborhood_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ neighborhood_PC1 + sociodemo_PC1, data = first_release_data)

firstrel1_neighborhood_mediationrev <- mediate(firstrel1_neighborhood_patharev, firstrel1_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel1_neighborhood_mediationrev)

## Rel 1 PC 2 Neighborhood
firstrel2_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = first_release_data)
firstrel2_neighborhood_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ neighborhood_PC1 + sociodemo_PC1, data = first_release_data)

firstrel2_neighborhood_mediationrev <- mediate(firstrel2_neighborhood_patharev, firstrel2_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel2_neighborhood_mediationrev)

## Rel 1 PC 3 Neighborhood
firstrel3_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = first_release_data)
firstrel3_neighborhood_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ neighborhood_PC1 + sociodemo_PC1, data = first_release_data)

firstrel3_neighborhood_mediationrev <- mediate(firstrel3_neighborhood_patharev, firstrel3_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel3_neighborhood_mediationrev)

## Rel 1 PC 1 Culture
firstrel1_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = first_release_data)
firstrel1_culture_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ culture_PC1 + sociodemo_PC1, data = first_release_data)

firstrel1_culture_mediationrev <- mediate(firstrel1_culture_patharev, firstrel1_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel1_culture_mediationrev)

## Rel 1 PC 2 Culture
firstrel2_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = first_release_data)
firstrel2_culture_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ culture_PC1 + sociodemo_PC1, data = first_release_data)

firstrel2_culture_mediationrev <- mediate(firstrel2_culture_patharev, firstrel2_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel2_culture_mediationrev)

## Rel 1 PC 3 Culture
firstrel3_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = first_release_data)
firstrel3_culture_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ culture_PC1 + sociodemo_PC1, data = first_release_data)

firstrel3_culture_mediationrev <- mediate(firstrel3_culture_patharev, firstrel3_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(firstrel3_culture_mediationrev)

```

## Release 2.0.1 reverse model 
```{r}
## Rel 1 PC 1 Home
secondrel1_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = second_release_data)
secondrel1_home_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ home_PC1 + sociodemo_PC1, data = second_release_data)

secondrel1_home_mediationrev <- mediate(secondrel1_home_patharev, secondrel1_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel1_home_mediationrev)

## Rel 1 PC 2 Home 
secondrel2_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = second_release_data)
secondrel2_home_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ home_PC1 + sociodemo_PC1, data = second_release_data)

secondrel2_home_mediationrev <- mediate(secondrel2_home_patharev, secondrel2_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel2_home_mediationrev)

## Rel 1 PC 3 Home 
secondrel3_home_patharev <- lm(sociodemo_PC1 ~ home_PC1, data = second_release_data)
secondrel3_home_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ home_PC1 + sociodemo_PC1, data = second_release_data)

secondrel3_home_mediationrev <- mediate(secondrel3_home_patharev, secondrel3_home_pathbrev, treat = 'home_PC1', mediator = 'sociodemo_PC1',
                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel3_home_mediationrev)

## Rel 1 PC 1 School 
secondrel1_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = second_release_data)
secondrel1_school_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ school_PC1 + sociodemo_PC1, data = second_release_data)

secondrel1_school_mediationrev <- mediate(secondrel1_school_patharev, secondrel1_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel1_school_mediationrev)

## Rel 1 PC 2 School
secondrel2_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = second_release_data)
secondrel2_school_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ school_PC1 + sociodemo_PC1, data = second_release_data)

secondrel2_school_mediationrev <- mediate(secondrel2_school_patharev, secondrel2_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel2_school_mediationrev)

## Rel 1 PC 3 School
secondrel3_school_patharev <- lm(sociodemo_PC1 ~ school_PC1, data = second_release_data)
secondrel3_school_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ school_PC1 + sociodemo_PC1, data = second_release_data)

secondrel3_school_mediationrev <- mediate(secondrel3_school_patharev, secondrel3_school_pathbrev, treat = 'school_PC1', mediator = 'sociodemo_PC1',
                                      boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel3_school_mediationrev)

## Rel 1 PC 1 Neighborhood
secondrel1_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = second_release_data)
secondrel1_neighborhood_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ neighborhood_PC1 + sociodemo_PC1, data = second_release_data)

secondrel1_neighborhood_mediationrev <- mediate(secondrel1_neighborhood_patharev, secondrel1_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel1_neighborhood_mediationrev)

## Rel 1 PC 2 Neighborhood
secondrel2_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = second_release_data)
secondrel2_neighborhood_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ neighborhood_PC1 + sociodemo_PC1, data = second_release_data)

secondrel2_neighborhood_mediationrev <- mediate(secondrel2_neighborhood_patharev, secondrel2_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel2_neighborhood_mediationrev)

## Rel 1 PC 3 Neighborhood
secondrel3_neighborhood_patharev <- lm(sociodemo_PC1 ~ neighborhood_PC1, data = second_release_data)
secondrel3_neighborhood_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ neighborhood_PC1 + sociodemo_PC1, data = second_release_data)

secondrel3_neighborhood_mediationrev <- mediate(secondrel3_neighborhood_patharev, secondrel3_neighborhood_pathbrev, 
                                            treat = 'neighborhood_PC1', mediator = 'sociodemo_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel3_neighborhood_mediationrev)

## Rel 1 PC 1 Culture
secondrel1_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = second_release_data)
secondrel1_culture_pathbrev <- lm(Neurocog_BPPC1_GenAbility ~ culture_PC1 + sociodemo_PC1, data = second_release_data)

secondrel1_culture_mediationrev <- mediate(secondrel1_culture_patharev, secondrel1_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel1_culture_mediationrev)

## Rel 1 PC 2 Culture
secondrel2_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = second_release_data)
secondrel2_culture_pathbrev <- lm(Neurocog_BPPC2_ExecFunc ~ culture_PC1 + sociodemo_PC1, data = second_release_data)

secondrel2_culture_mediationrev <- mediate(secondrel2_culture_patharev, secondrel2_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel2_culture_mediationrev)

## Rel 1 PC 3 Culture
secondrel3_culture_patharev <- lm(sociodemo_PC1 ~ culture_PC1, data = second_release_data)
secondrel3_culture_pathbrev <- lm(Neurocog_BPPC3_LearnMem ~ culture_PC1 + sociodemo_PC1, data = second_release_data)

secondrel3_culture_mediationrev <- mediate(secondrel3_culture_patharev, secondrel3_culture_pathbrev, treat = 'culture_PC1', mediator = 'sociodemo_PC1',
                                       boot = TRUE, sims = 5000, boot.ci.type = 'bca')
summary(secondrel3_culture_mediationrev)

```


## Bonferoni correct p values 
```{r}
## Create vectors for p values 

### Release 1.1
#### Standard Model
rel1_mediation_pvals <- c(rep(NA, 12))

rel1_mediation_pvals[1] <- firstrel1_home_mediation$n.avg.p
rel1_mediation_pvals[2] <- firstrel2_home_mediation$n.avg.p
rel1_mediation_pvals[3] <- firstrel3_home_mediation$n.avg.p
rel1_mediation_pvals[4] <- firstrel1_school_mediation$n.avg.p
rel1_mediation_pvals[5] <- firstrel2_school_mediation$n.avg.p
rel1_mediation_pvals[6] <- firstrel3_school_mediation$n.avg.p
rel1_mediation_pvals[7] <- firstrel1_neighborhood_mediation$n.avg.p
rel1_mediation_pvals[8] <- firstrel2_neighborhood_mediation$n.avg.p
rel1_mediation_pvals[9] <- firstrel3_neighborhood_mediation$n.avg.p
rel1_mediation_pvals[10] <- firstrel1_culture_mediation$n.avg.p
rel1_mediation_pvals[11] <- firstrel2_culture_mediation$n.avg.p
rel1_mediation_pvals[12] <- firstrel3_culture_mediation$n.avg.p

#### Reverse Model
rel1_mediationrev_pvals <- c(rep(NA, 12))

rel1_mediationrev_pvals[1] <- firstrel1_home_mediationrev$n.avg.p
rel1_mediationrev_pvals[2] <- firstrel2_home_mediationrev$n.avg.p
rel1_mediationrev_pvals[3] <- firstrel3_home_mediationrev$n.avg.p
rel1_mediationrev_pvals[4] <- firstrel1_school_mediationrev$n.avg.p
rel1_mediationrev_pvals[5] <- firstrel2_school_mediationrev$n.avg.p
rel1_mediationrev_pvals[6] <- firstrel3_school_mediationrev$n.avg.p
rel1_mediationrev_pvals[7] <- firstrel1_neighborhood_mediationrev$n.avg.p
rel1_mediationrev_pvals[8] <- firstrel2_neighborhood_mediationrev$n.avg.p
rel1_mediationrev_pvals[9] <- firstrel3_neighborhood_mediationrev$n.avg.p
rel1_mediationrev_pvals[10] <- firstrel1_culture_mediationrev$n.avg.p
rel1_mediationrev_pvals[11] <- firstrel2_culture_mediationrev$n.avg.p
rel1_mediationrev_pvals[12] <- firstrel3_culture_mediationrev$n.avg.p

### Release 2.0.1
#### Standard model
rel2_mediation_pvals <- c(rep(NA, 12))

rel2_mediation_pvals[1] <- secondrel1_home_mediation$n.avg.p
rel2_mediation_pvals[2] <- secondrel2_home_mediation$n.avg.p
rel2_mediation_pvals[3] <- secondrel3_home_mediation$n.avg.p
rel2_mediation_pvals[4] <- secondrel1_school_mediation$n.avg.p
rel2_mediation_pvals[5] <- secondrel2_school_mediation$n.avg.p
rel2_mediation_pvals[6] <- secondrel3_school_mediation$n.avg.p
rel2_mediation_pvals[7] <- secondrel1_neighborhood_mediation$n.avg.p
rel2_mediation_pvals[8] <- secondrel2_neighborhood_mediation$n.avg.p
rel2_mediation_pvals[9] <- secondrel3_neighborhood_mediation$n.avg.p
rel2_mediation_pvals[10] <- secondrel1_culture_mediation$n.avg.p
rel2_mediation_pvals[11] <- secondrel2_culture_mediation$n.avg.p
rel2_mediation_pvals[12] <- secondrel3_culture_mediation$n.avg.p

#### Reverse model
rel2_mediationrev_pvals <- c(rep(NA, 12))

rel2_mediationrev_pvals[1] <- secondrel1_home_mediationrev$n.avg.p
rel2_mediationrev_pvals[2] <- secondrel2_home_mediationrev$n.avg.p
rel2_mediationrev_pvals[3] <- secondrel3_home_mediationrev$n.avg.p
rel2_mediationrev_pvals[4] <- secondrel1_school_mediationrev$n.avg.p
rel2_mediationrev_pvals[5] <- secondrel2_school_mediationrev$n.avg.p
rel2_mediationrev_pvals[6] <- secondrel3_school_mediationrev$n.avg.p
rel2_mediationrev_pvals[7] <- secondrel1_neighborhood_mediationrev$n.avg.p
rel2_mediationrev_pvals[8] <- secondrel2_neighborhood_mediationrev$n.avg.p
rel2_mediationrev_pvals[9] <- secondrel3_neighborhood_mediationrev$n.avg.p
rel2_mediationrev_pvals[10] <- secondrel1_culture_mediationrev$n.avg.p
rel2_mediationrev_pvals[11] <- secondrel2_culture_mediationrev$n.avg.p
rel2_mediationrev_pvals[12] <- secondrel3_culture_mediationrev$n.avg.p

## Correct for multiple comparisons 

### Release 1.1 
#### Standard model
rel1_mediation_pvals_corrected <- p.adjust(rel1_mediation_pvals, method = "bonferroni", n = length(rel1_mediation_pvals))

#### Reverse model
rel1_mediationrev_pvals_corrected <- p.adjust(rel1_mediationrev_pvals, method = "bonferroni", n = length(rel1_mediationrev_pvals))

### Release 2.0.1 
#### Standard model
rel2_mediation_pvals_corrected <- p.adjust(rel2_mediation_pvals, method = "bonferroni", n = length(rel2_mediation_pvals))

#### Reverse model
rel2_mediationrev_pvals_corrected <- p.adjust(rel2_mediationrev_pvals, method = "bonferroni", n = length(rel2_mediationrev_pvals))

```


## Visualize mediation effects and relationships between Enviro PCs and Cog outcomes 
```{r}

## subset PCs from first and second rel and correlate 

rel1_pc_corr <- first_release_data %>%
  dplyr::select(home_PC1, school_PC1, neighborhood_PC1, culture_PC1, Neurocog_BPPC1_GenAbility, Neurocog_BPPC2_ExecFunc, Neurocog_BPPC3_LearnMem) %>%
  cor()

rel2_pc_corr <- second_release_data %>%
  dplyr::select(home_PC1, school_PC1, neighborhood_PC1, culture_PC1, Neurocog_BPPC1_GenAbility, Neurocog_BPPC2_ExecFunc, Neurocog_BPPC3_LearnMem) %>%
  cor()

(corrplot(rel1_pc_corr))
(corrplot(rel2_pc_corr))

release_pc_corrs <- data.frame(rel1_BPPC1 = rel1_pc_corr[1:4, 5], rel2_BPPC1 = rel2_pc_corr[1:4, 5],
                               rel1_BPPC2 = rel1_pc_corr[1:4, 6], rel2_BPPC2 = rel2_pc_corr[1:4, 6],
                               rel1_BPPC3 = rel1_pc_corr[1:4, 7], rel2_BPPC3 = rel2_pc_corr[1:4, 7])




## Grab and order orrected p-vales for standard and reverse models 

release_pc_pvals <- data.frame(rel1_BPPC1 = rel1_mediation_pvals_corrected[c(1,4,7,10)], rel2_BPPC1 = rel2_mediation_pvals_corrected[c(1,4,7,10)],
                               rel1_BPPC2 = rel1_mediation_pvals_corrected[c(2,5,8,11)], rel2_BPPC2 = rel2_mediation_pvals_corrected[c(2,5,8,11)],
                               rel1_BPPC3 = rel1_mediation_pvals_corrected[c(3,6,9,12)], rel2_BPPC3 = rel2_mediation_pvals_corrected[c(3,6,9,12)])

releaserev_pc_pvals <- data.frame(rel1_BPPC1 = rel1_mediationrev_pvals_corrected[c(1,4,7,10)], rel2_BPPC1 = rel2_mediationrev_pvals_corrected[c(1,4,7,10)],
                               rel1_BPPC2 = rel1_mediationrev_pvals_corrected[c(2,5,8,11)], rel2_BPPC2 = rel2_mediationrev_pvals_corrected[c(2,5,8,11)],
                               rel1_BPPC3 = rel1_mediationrev_pvals_corrected[c(3,6,9,12)], rel2_BPPC3 = rel2_mediationrev_pvals_corrected[c(3,6,9,12)])

## Plot Corrplots with corrected bonferroni p-values 

png("release_standmed_corrplot.png", res = 600, width = 10000, height = 5000)
(release_standmed_corrplot <- corrplot(as.matrix(release_pc_corrs), method = 'color', type = "full", diag = FALSE, p.mat = as.matrix(release_pc_pvals), 
                              insig = "label_sig", cl.pos = "r", cl.cex = 2, pch.col = "black", pch.cex = 5, tl.cex = 2.15, tl.srt = 20, tl.col = "black"))
dev.off()

png("release_revmed_corrplot.png", res = 600, width = 10000, height = 5000)
(release_revmed_corrplot <- corrplot(as.matrix(release_pc_corrs), method = 'color', type = "full", diag = FALSE, p.mat = as.matrix(releaserev_pc_pvals), 
                              insig = "label_sig", cl.pos = "r", cl.cex = 2, pch.col = "black", pch.cex = 5, tl.cex = 2.15, tl.srt = 20, tl.col = "black"))
dev.off()


```


## Site split groups 1 and 2 mediation
```{r message=false, warning=FALSE, results='hide'}
#Site one empty lists
site1pc1_home_mediation <- vector("list", nrand)
site1pc1_school_mediation <- vector("list", nrand)
site1pc1_neighborhood_mediation <- vector("list", nrand)
site1pc1_culture_mediation <- vector("list", nrand)

site1pc2_home_mediation <- vector("list", nrand)
site1pc2_school_mediation <- vector("list", nrand)
site1pc2_neighborhood_mediation <- vector("list", nrand)
site1pc2_culture_mediation <- vector("list", nrand)

site1pc3_home_mediation <- vector("list", nrand)
site1pc3_school_mediation <- vector("list", nrand)
site1pc3_neighborhood_mediation <- vector("list", nrand)
site1pc3_culture_mediation <- vector("list", nrand)

#Site 2 empty lists
site2pc1_home_mediation <- vector("list", nrand)
site2pc1_school_mediation <- vector("list", nrand)
site2pc1_neighborhood_mediation <- vector("list", nrand)
site2pc1_culture_mediation <- vector("list", nrand)

site2pc2_home_mediation <- vector("list", nrand)
site2pc2_school_mediation <- vector("list", nrand)
site2pc2_neighborhood_mediation <- vector("list", nrand)
site2pc2_culture_mediation <- vector("list", nrand)

site2pc3_home_mediation <- vector("list", nrand)
site2pc3_school_mediation <- vector("list", nrand)
site2pc3_neighborhood_mediation <- vector("list", nrand)
site2pc3_culture_mediation <- vector("list", nrand)

for (i in 1:nrand){
#### Site Group 1 Mediations ####  
    site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,i]) %>%
    mutate(culture_PC1 = site1_culture_PC_list[[i]]$ind$coord[,1],
               home_PC1 = site1_home_PC_list[[i]]$ind$coord[,1],
               school_PC1 = site1_school_PC_list[[i]]$ind$coord[,1],
               neighborhood_PC1 = site1_neighborhood_PC_list[[i]]$ind$coord[,1],
               sociodemo_PC1 = site1_sociodemo_PC_list[[i]]$ind$coord[,1],
               neurocog_PC1 = site1_neurocog_PC_list[[i]]$ind$coord[,1],
               neurocog_PC2 = site1_neurocog_PC_list[[i]]$ind$coord[,2],
               neurocog_PC3 = site1_neurocog_PC_list[[i]]$ind$coord[,3])
    
#Site group 1: school neurocog dim 1 
site1pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1pc1_school_mediation[[i]] <- mediate(site1pc1_school_demenviro_patha, site1pc1_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                          boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: school neurocog dim 2 
site1pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1pc2_school_mediation[[i]] <- mediate(site1pc2_school_demenviro_patha, site1pc2_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: school neurocog dim 3 
site1pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1pc3_school_mediation[[i]] <- mediate(site1pc3_school_demenviro_patha, site1pc3_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: home neurocog dim 1 
site1pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1pc1_home_mediation[[1]] <- mediate(site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: home neurocog dim 2 
site1pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1pc2_home_mediation[[i]] <- mediate(site1pc2_home_demenviro_patha, site1pc2_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: home neurocog dim 3 
site1pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1pc3_home_mediation[[i]] <- mediate(site1pc3_home_demenviro_patha, site1pc3_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: culture neurocog dim 1 
site1pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1pc1_culture_mediation[[i]] <- mediate(site1pc1_culture_demenviro_patha, site1pc1_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: culture neurocog dim 2
site1pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1pc2_culture_mediation[[i]] <- mediate(site1pc2_culture_demenviro_patha, site1pc2_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: culture neurocog dim 3
site1pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1pc3_culture_mediation[[i]] <- mediate(site1pc3_culture_demenviro_patha, site1pc3_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: neighborhood neurocog dim 1 
site1pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1pc1_neighborhood_mediation[[i]] <- mediate(site1pc1_neighborhood_demenviro_patha, site1pc1_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                                mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: neighborhood neurocog dim 2
site1pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1pc2_neighborhood_mediation[[i]] <- mediate(site1pc2_neighborhood_demenviro_patha, site1pc2_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                        mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 1: neighborhood neurocog dim 3
site1pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1pc3_neighborhood_mediation[[i]] <- mediate(site1pc3_neighborhood_demenviro_patha, site1pc3_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                           mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

#### Site Group 2 Mediations ####  
  site2_data <- abcd_data_final %>%
    filter(abcd_site %nin% site_splits_rand[,i]) %>%
    mutate(culture_PC1 = site2_culture_PC_list[[i]]$ind$coord[,1],
               home_PC1 = site2_home_PC_list[[i]]$ind$coord[,1],
               school_PC1 = site2_school_PC_list[[i]]$ind$coord[,1],
               neighborhood_PC1 = site2_neighborhood_PC_list[[i]]$ind$coord[,1],
               sociodemo_PC1 = site2_sociodemo_PC_list[[i]]$ind$coord[,1],
               neurocog_PC1 = site2_neurocog_PC_list[[i]]$ind$coord[,1],
               neurocog_PC2 = site2_neurocog_PC_list[[i]]$ind$coord[,2],
               neurocog_PC3 = site2_neurocog_PC_list[[i]]$ind$coord[,3])

#Site group 2: school neurocog dim 1 
site2pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2pc1_school_mediation[[i]] <- mediate(site2pc1_school_demenviro_patha, site2pc1_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                          boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: school neurocog dim 2 
site2pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2pc2_school_mediation[[i]] <- mediate(site2pc2_school_demenviro_patha, site2pc2_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: school neurocog dim 3 
site2pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2pc3_school_mediation[[i]] <- mediate(site2pc3_school_demenviro_patha, site2pc3_school_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'school_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: home neurocog dim 1 
site2pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2pc1_home_mediation[[1]] <- mediate(site2pc1_home_demenviro_patha, site2pc1_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: home neurocog dim 2 
site2pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2pc2_home_mediation[[i]] <- mediate(site2pc2_home_demenviro_patha, site2pc2_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: home neurocog dim 3 
site2pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2pc3_home_mediation[[i]] <- mediate(site2pc3_home_demenviro_patha, site2pc3_home_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'home_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: culture neurocog dim 1 
site2pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2pc1_culture_mediation[[i]] <- mediate(site2pc1_culture_demenviro_patha, site2pc1_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: culture neurocog dim 2
site2pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2pc2_culture_mediation[[i]] <- mediate(site2pc2_culture_demenviro_patha, site2pc2_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: culture neurocog dim 3
site2pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2pc3_culture_mediation[[i]] <- mediate(site2pc3_culture_demenviro_patha, site2pc3_culture_envirocog_pathb, treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: neighborhood neurocog dim 1 
site2pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2pc1_neighborhood_mediation[[i]] <- mediate(site2pc1_neighborhood_demenviro_patha, site2pc1_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                                mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: neighborhood neurocog dim 2
site2pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2pc2_neighborhood_mediation[[i]] <- mediate(site2pc2_neighborhood_demenviro_patha, site2pc2_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                        mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')
#Site group 2: neighborhood neurocog dim 3
site2pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2pc3_neighborhood_mediation[[i]] <- mediate(site2pc3_neighborhood_demenviro_patha, site2pc3_neighborhood_envirocog_pathb, treat = 'sociodemo_PC1', 
                                           mediator = 'neighborhood_PC1', boot = TRUE, sims = 5000, boot.ci.type = 'bca')

rm(site1_data, site2_data, site1pc1_culture_demenviro_patha, site1pc1_culture_envirocog_pathb, site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb,
   site1pc1_neighborhood_demenviro_patha, site1pc1_neighborhood_envirocog_pathb, site1pc1_school_demenviro_patha, site1pc1_school_envirocog_pathb,
   site1pc2_culture_demenviro_patha, site1pc2_culture_envirocog_pathb, site1pc2_home_demenviro_patha, site1pc2_home_envirocog_pathb,
   site1pc2_neighborhood_demenviro_patha, site1pc2_neighborhood_envirocog_pathb, site1pc2_school_demenviro_patha, site1pc2_school_envirocog_pathb,
   site1pc3_culture_demenviro_patha, site1pc3_culture_envirocog_pathb, site1pc3_home_demenviro_patha, site1pc3_home_envirocog_pathb,
   site1pc3_neighborhood_demenviro_patha, site1pc3_neighborhood_envirocog_pathb, site1pc3_school_demenviro_patha, site1pc3_school_envirocog_pathb,
   site2pc1_culture_demenviro_patha, site2pc1_culture_envirocog_pathb, site2pc1_home_demenviro_patha, site2pc1_home_envirocog_pathb,
   site2pc1_neighborhood_demenviro_patha, site2pc1_neighborhood_envirocog_pathb, site2pc1_school_demenviro_patha, site2pc1_school_envirocog_pathb,
   site2pc2_culture_demenviro_patha, site2pc2_culture_envirocog_pathb, site2pc2_home_demenviro_patha, site2pc2_home_envirocog_pathb,
   site2pc2_neighborhood_demenviro_patha, site2pc2_neighborhood_envirocog_pathb, site2pc2_school_demenviro_patha, site2pc2_school_envirocog_pathb,
   site2pc3_culture_demenviro_patha, site2pc3_culture_envirocog_pathb, site2pc3_home_demenviro_patha, site2pc3_home_envirocog_pathb,
   site2pc3_neighborhood_demenviro_patha, site2pc3_neighborhood_envirocog_pathb, site2pc3_school_demenviro_patha, site2pc3_school_envirocog_pathb) 




}

```

## Write for parallel processing
```{r}
library(parallel); library(MASS)


```



# Temporary - test timing for one BPPCA
```{r}
site_mediation <- function(index){
  
 message(paste('Working on index #',index))
  
    #### Site Group 1 Mediations ####  
    site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site1_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site1_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site1_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site1_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site1_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site1_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site1_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site1_neurocog_PC_list[[index]]$ind$coord[,3])

    #Site group 1: home neurocog dim 1 
site1pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[[1]] <<- mediate(site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc1 <<-  site1_mediation[[1]]$n.avg

#Site group 1: home neurocog dim 2 
site1pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[[2]] <<- mediate(site1pc2_home_demenviro_patha, site1pc2_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc2 <<-  site1_mediation[[2]]$n.avg

#Site group 1: home neurocog dim 3 
site1pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[[3]] <<- mediate(site1pc3_home_demenviro_patha, site1pc3_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc3 <<-  site1_mediation[[3]]$n.avg

#Site group 1: school neurocog dim 1 
site1pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[[4]] <<- mediate(site1pc1_school_demenviro_patha, site1pc1_school_envirocog_pathb, 
                                             treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc1 <<-  site1_mediation[[4]]$n.avg

#Site group 1: school neurocog dim 2 
site1pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[[5]] <<- mediate(site1pc2_school_demenviro_patha, site1pc2_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc2 <<-  site1_mediation[[5]]$n.avg

#Site group 1: school neurocog dim 3 
site1pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[[6]] <<- mediate(site1pc3_school_demenviro_patha, site1pc3_school_envirocog_pathb, 
                                          treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                          boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc3 <<-  site1_mediation[[6]]$n.avg

#Site group 1: neighborhood neurocog dim 1 
site1pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[[7]] <<- mediate(site1pc1_neighborhood_demenviro_patha, site1pc1_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1',
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc1 <<-  site1_mediation[[7]]$n.avg

#Site group 1: neighborhood neurocog dim 2
site1pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[[8]] <<- mediate(site1pc2_neighborhood_demenviro_patha, site1pc2_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc2 <<-  site1_mediation[[8]]$n.avg

#Site group 1: neighborhood neurocog dim 3
site1pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[[9]] <<- mediate(site1pc3_neighborhood_demenviro_patha, site1pc3_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc3 <<-  site1_mediation[[9]]$n.avg

#Site group 1: culture neurocog dim 1 
site1pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[[10]] <<- mediate(site1pc1_culture_demenviro_patha, site1pc1_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc1 <<-  site1_mediation[[10]]$n.avg

#Site group 1: culture neurocog dim 2
site1pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[[11]] <<- mediate(site1pc2_culture_demenviro_patha, site1pc2_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc2 <<-  site1_mediation[[11]]$n.avg

#Site group 1: culture neurocog dim 3
site1pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[[12]] <<- mediate(site1pc3_culture_demenviro_patha, site1pc3_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc3 <<-  site1_mediation[[12]]$n.avg


return(list(c(site1_mediation, site1_propmediated)))
    
  }

  

```

## temp storage - 2nd site split 
```{r}

#### Site Group 2 Mediations ####  
  site2_data <- abcd_data_final %>%
    filter(abcd_site %nin% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site2_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site2_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site2_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site2_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site2_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site2_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site2_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site2_neurocog_PC_list[[index]]$ind$coord[,3])

#Site group 2: home neurocog dim 1 
site2pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 1][[1]] <<- mediate(site2pc1_home_demenviro_patha, site2pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc1[index] <<-  site2_mediation[index, 1][[1]]$n.avg

#Site group 2: home neurocog dim 2 
site2pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 2][[1]] <<- mediate(site2pc2_home_demenviro_patha, site2pc2_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc2[index] <<-  site2_mediation[index, 2][[1]]$n.avg

#Site group 2: home neurocog dim 3 
site2pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 3][[1]] <<- mediate(site2pc3_home_demenviro_patha, site2pc3_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1',
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc3[index] <<-  site2_mediation[index, 3][[1]]$n.avg

#Site group 2: school neurocog dim 1 
site2pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 4][[1]] <<- mediate(site2pc1_school_demenviro_patha, site2pc1_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc1[index] <<-  site2_mediation[index, 4][[1]]$n.avg

#Site group 2: school neurocog dim 2 
site2pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 5][[1]] <<- mediate(site2pc2_school_demenviro_patha, site2pc2_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc2[index] <<-  site2_mediation[index, 5][[1]]$n.avg

#Site group 2: school neurocog dim 3 
site2pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 6][[1]] <<- mediate(site2pc3_school_demenviro_patha, site2pc3_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1', 
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc3[index] <<-  site2_mediation[index, 6][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 1 
site2pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 7][[1]] <<- mediate(site2pc1_neighborhood_demenviro_patha, site2pc1_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc1[index] <<-  site2_mediation[index, 7][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 2
site2pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 8][[1]] <<- mediate(site2pc2_neighborhood_demenviro_patha, site2pc2_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc2[index] <<-  site2_mediation[index, 8][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 3
site2pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 9][[1]] <<- mediate(site2pc3_neighborhood_demenviro_patha, site2pc3_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc3[index] <<-  site2_mediation[index, 9][[1]]$n.avg

#Site group 2: culture neurocog dim 1 
site2pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 10][[1]] <<- mediate(site2pc1_culture_demenviro_patha, site2pc1_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc1[index] <<-  site2_mediation[index, 10][[1]]$n.avg

#Site group 2: culture neurocog dim 2
site2pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 11][[1]] <<- mediate(site2pc2_culture_demenviro_patha, site2pc2_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc2[index] <<-  site2_mediation[index, 11][[1]]$n.avg

#Site group 2: culture neurocog dim 3
site2pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 12][[1]] <<- mediate(site2pc3_culture_demenviro_patha, site2pc3_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc3[index] <<-  site2_mediation[index, 12][[1]]$n.avg
```


## Attempt parallel processing with foreach 
```{r}
site1_mediation <- matrix(list(), nrow = nrand, ncol = 12)
site1_propmediated <- data.frame(home_bppc1 = rep(NA, nrand), home_bppc2 = rep(NA, nrand), home_bppc3 = rep(NA, nrand), 
                                 school_bppc1 = rep(NA, nrand), school_bppc2 = rep(NA, nrand), school_bppc3 = rep(NA, nrand), 
                                 neighborhood_bppc1 = rep(NA, nrand), neighborhood_bppc2 = rep(NA, nrand), neighborhood_bppc3 = rep(NA, nrand),
                                 culture_bppc1 = rep(NA, nrand), culture_bppc2 = rep(NA, nrand), culture_bppc3 = rep(NA, nrand))

site2_mediation <- matrix(list(), nrow = nrand, ncol = 12)
site2_propmediated <- data.frame(home_bppc1 = rep(NA, nrand), home_bppc2 = rep(NA, nrand), home_bppc3 = rep(NA, nrand), 
                                 school_bppc1 = rep(NA, nrand), school_bppc2 = rep(NA, nrand), school_bppc3 = rep(NA, nrand), 
                                 neighborhood_bppc1 = rep(NA, nrand), neighborhood_bppc2 = rep(NA, nrand), neighborhood_bppc3 = rep(NA, nrand),
                                 culture_bppc1 = rep(NA, nrand), culture_bppc2 = rep(NA, nrand), culture_bppc3 = rep(NA, nrand))

registerDoParallel(cores = 2)

foreach(index = 1:2, .inorder = FALSE, .export = c("site1_mediation", "site1_propmediated", "site2_mediation", "site2_propmediated"),
        .verbose = TRUE) %dopar% {
   message(paste('Working on index #',index))
  
    #### Site Group 1 Mediations ####  
    site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site1_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site1_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site1_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site1_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site1_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site1_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site1_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site1_neurocog_PC_list[[index]]$ind$coord[,3])

    #Site group 1: home neurocog dim 1 
site1pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[index, 1][[1]] <<- mediate(site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc1[index] <<-  site1_mediation[index, 1][[1]]$n.avg

#Site group 1: home neurocog dim 2 
site1pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[index, 2][[1]] <<- mediate(site1pc2_home_demenviro_patha, site1pc2_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc2[index] <<-  site1_mediation[index, 2][[1]]$n.avg

#Site group 1: home neurocog dim 3 
site1pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[index, 3][[1]] <<- mediate(site1pc3_home_demenviro_patha, site1pc3_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc3[index] <<-  site1_mediation[index, 3][[1]]$n.avg

#Site group 1: school neurocog dim 1 
site1pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[index, 4][[1]] <<- mediate(site1pc1_school_demenviro_patha, site1pc1_school_envirocog_pathb, 
                                             treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                             boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc1[index] <<-  site1_mediation[index, 4][[1]]$n.avg

#Site group 1: school neurocog dim 2 
site1pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[index, 5][[1]] <<- mediate(site1pc2_school_demenviro_patha, site1pc2_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc2[index] <<-  site1_mediation[index, 5][[1]]$n.avg

#Site group 1: school neurocog dim 3 
site1pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site1_data)
site1_mediation[index, 6][[1]] <<- mediate(site1pc3_school_demenviro_patha, site1pc3_school_envirocog_pathb, 
                                          treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                          boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$school_bppc3[index] <<-  site1_mediation[index, 6][[1]]$n.avg

#Site group 1: neighborhood neurocog dim 1 
site1pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[index, 7][[1]] <<- mediate(site1pc1_neighborhood_demenviro_patha, site1pc1_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1',
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc1[index] <<-  site1_mediation[index, 7][[1]]$n.avg

#Site group 1: neighborhood neurocog dim 2
site1pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[index, 8][[1]] <<- mediate(site1pc2_neighborhood_demenviro_patha, site1pc2_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc2[index] <<-  site1_mediation[index, 8][[1]]$n.avg

#Site group 1: neighborhood neurocog dim 3
site1pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site1_data)
site1_mediation[index, 9][[1]] <<- mediate(site1pc3_neighborhood_demenviro_patha, site1pc3_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$neighborhood_bppc3[index] <<-  site1_mediation[index, 9][[1]]$n.avg

#Site group 1: culture neurocog dim 1 
site1pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[index, 10][[1]] <<- mediate(site1pc1_culture_demenviro_patha, site1pc1_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc1[index] <<-  site1_mediation[index, 10][[1]]$n.avg

#Site group 1: culture neurocog dim 2
site1pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[index, 11][[1]] <<- mediate(site1pc2_culture_demenviro_patha, site1pc2_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1',
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc2[index] <<-  site1_mediation[index, 11][[1]]$n.avg

#Site group 1: culture neurocog dim 3
site1pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site1_data)
site1_mediation[index, 12][[1]] <<- mediate(site1pc3_culture_demenviro_patha, site1pc3_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$culture_bppc3[index] <<-  site1_mediation[index, 12][[1]]$n.avg


#### Site Group 2 Mediations ####  
  site2_data <- abcd_data_final %>%
    filter(abcd_site %nin% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site2_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site2_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site2_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site2_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site2_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site2_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site2_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site2_neurocog_PC_list[[index]]$ind$coord[,3])

#Site group 2: home neurocog dim 1 
site2pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 1][[1]] <<- mediate(site2pc1_home_demenviro_patha, site2pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc1[index] <<-  site2_mediation[index, 1][[1]]$n.avg

#Site group 2: home neurocog dim 2 
site2pc2_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_home_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 2][[1]] <<- mediate(site2pc2_home_demenviro_patha, site2pc2_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc2[index] <<-  site2_mediation[index, 2][[1]]$n.avg

#Site group 2: home neurocog dim 3 
site2pc3_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_home_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + home_PC1, data = site2_data)
site2_mediation[index, 3][[1]] <<- mediate(site2pc3_home_demenviro_patha, site2pc3_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1',
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$home_bppc3[index] <<-  site2_mediation[index, 3][[1]]$n.avg

#Site group 2: school neurocog dim 1 
site2pc1_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_school_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 4][[1]] <<- mediate(site2pc1_school_demenviro_patha, site2pc1_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc1[index] <<-  site2_mediation[index, 4][[1]]$n.avg

#Site group 2: school neurocog dim 2 
site2pc2_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_school_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 5][[1]] <<- mediate(site2pc2_school_demenviro_patha, site2pc2_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1',
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc2[index] <<-  site2_mediation[index, 5][[1]]$n.avg

#Site group 2: school neurocog dim 3 
site2pc3_school_demenviro_patha <- lm(school_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_school_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + school_PC1, data = site2_data)
site2_mediation[index, 6][[1]] <<- mediate(site2pc3_school_demenviro_patha, site2pc3_school_envirocog_pathb, 
                                                    treat = 'sociodemo_PC1', mediator = 'school_PC1', 
                                                    boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$school_bppc3[index] <<-  site2_mediation[index, 6][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 1 
site2pc1_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 7][[1]] <<- mediate(site2pc1_neighborhood_demenviro_patha, site2pc1_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc1[index] <<-  site2_mediation[index, 7][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 2
site2pc2_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 8][[1]] <<- mediate(site2pc2_neighborhood_demenviro_patha, site2pc2_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc2[index] <<-  site2_mediation[index, 8][[1]]$n.avg

#Site group 2: neighborhood neurocog dim 3
site2pc3_neighborhood_demenviro_patha <- lm(neighborhood_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_neighborhood_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + neighborhood_PC1, data = site2_data)
site2_mediation[index, 9][[1]] <<- mediate(site2pc3_neighborhood_demenviro_patha, site2pc3_neighborhood_envirocog_pathb, 
                                                           treat = 'sociodemo_PC1', mediator = 'neighborhood_PC1', 
                                                           boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$neighborhood_bppc3[index] <<-  site2_mediation[index, 9][[1]]$n.avg

#Site group 2: culture neurocog dim 1 
site2pc1_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc1_culture_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 10][[1]] <<- mediate(site2pc1_culture_demenviro_patha, site2pc1_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc1[index] <<-  site2_mediation[index, 10][[1]]$n.avg

#Site group 2: culture neurocog dim 2
site2pc2_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc2_culture_envirocog_pathb <- lm(Neurocog_BPPC2_ExecFunc ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 11][[1]] <<- mediate(site2pc2_culture_demenviro_patha, site2pc2_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc2[index] <<-  site2_mediation[index, 11][[1]]$n.avg

#Site group 2: culture neurocog dim 3
site2pc3_culture_demenviro_patha <- lm(culture_PC1 ~ sociodemo_PC1, data = site2_data)
site2pc3_culture_envirocog_pathb <- lm(Neurocog_BPPC3_LearnMem ~ sociodemo_PC1 + culture_PC1, data = site2_data)
site2_mediation[index, 12][[1]] <<- mediate(site2pc3_culture_demenviro_patha, site2pc3_culture_envirocog_pathb, 
                                                     treat = 'sociodemo_PC1', mediator = 'culture_PC1', 
                                                     boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site2_propmediated$culture_bppc3[index] <<-  site2_mediation[index, 12][[1]]$n.avg
}
  
stopCluster(cl)

```


## Plot distribution of mediation effects
```{r}
site1_mediation <- vector("list", 12)
site1_propmediated <- data.frame(home_bppc1 = NA, home_bppc2 = NA, home_bppc3 = NA, 
                                 school_bppc1 = NA, school_bppc2 = NA, school_bppc3 = NA, 
                                 neighborhood_bppc1 = NA, neighborhood_bppc2 = NA, neighborhood_bppc3 = NA,
                                 culture_bppc1 = NA, culture_bppc2 = NA, culture_bppc3 = NA)

site2_mediation <- vector("list", 12)
site2_propmediated <- data.frame(home_bppc1 = NA, home_bppc2 = NA, home_bppc3 = NA, 
                                 school_bppc1 = NA, school_bppc2 = NA, school_bppc3 = NA, 
                                 neighborhood_bppc1 = NA, neighborhood_bppc2 = NA, neighborhood_bppc3 = NA,
                                 culture_bppc1 = NA, culture_bppc2 = NA, culture_bppc3 = NA)


index <- c(1:1000)
system.time({
   sitemed_results <- mclapply(index, site_mediation, mc.cores = 5, mc.preschedule = FALSE)
  
})

```

## baby test function
```{r}

index <- 1

    site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site1_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site1_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site1_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site1_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site1_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site1_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site1_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site1_neurocog_PC_list[[index]]$ind$coord[,3])

    #Site group 1: home neurocog dim 1 
site1pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site1_data)
site1_mediation[[1]] <<- mediate(site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_propmediated$home_bppc1 <<-  site1_mediation[[1]]$n.avg



answers <- data.frame(Square = rep(NA, 12))
answers_list <- matrix(list(), nrow = 4, ncol = 3)



trials <- seq(1:12)

squareme <- function(trial){
  answers$Square[trial] <<- trial*trial
  
  answers_list[3,2][[1]] <<- trial
}

lapply(trials, squareme)



```


```{r}
index <- 1
 site1_data <- abcd_data_final %>%
    filter(abcd_site %in% site_splits_rand[,index]) %>%
    mutate(culture_PC1 = site1_culture_PC_list[[index]]$ind$coord[,1],
               home_PC1 = site1_home_PC_list[[index]]$ind$coord[,1],
               school_PC1 = site1_school_PC_list[[index]]$ind$coord[,1],
               neighborhood_PC1 = site1_neighborhood_PC_list[[index]]$ind$coord[,1],
               sociodemo_PC1 = site1_sociodemo_PC_list[[index]]$ind$coord[,1],
               neurocog_PC1 = site1_neurocog_PC_list[[index]]$ind$coord[,1],
               neurocog_PC2 = site1_neurocog_PC_list[[index]]$ind$coord[,2],
               neurocog_PC3 = site1_neurocog_PC_list[[index]]$ind$coord[,3])

    #Site group 1: home neurocog dim 1 
site1pc1_home_demenviro_patha <- lm(home_PC1 ~ sociodemo_PC1, data = site1_data)
site1pc1_home_envirocog_pathb <- lm(Neurocog_BPPC1_GenAbility ~ sociodemo_PC1 + home_PC1, data = site1_data)
temp_med <- mediate(site1pc1_home_demenviro_patha, site1pc1_home_envirocog_pathb, 
                                                  treat = 'sociodemo_PC1', mediator = 'home_PC1', 
                                                  boot = TRUE, sims = 5000, boot.ci.type = 'bca')
site1_mediation[index, 1][[1]] <- temp_med
site1_propmediated$home_bppc1[index] <-  site1_mediation[index, 1][[1]]$n.avg
```

